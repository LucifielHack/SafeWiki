(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([[15],{157:function(e,t,n){"use strict";n.r(t),function(e){n.d(t,"default",(function(){return d}));var o,r=n(95),l=(n(139),n(0),n(96));function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function a(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},l=Object.keys(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(o=0;o<l.length;o++)n=l[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}(o="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.enterModule:void 0)&&o(e);"undefined"!=typeof reactHotLoaderGlobal&&reactHotLoaderGlobal.default.signature;var s,c,i=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(l.b)("div",t)}},b={},u="wrapper";function d(e){var t=e.components,n=a(e,["components"]);return Object(l.b)(u,p({},b,n,{components:t,mdxType:"MDXLayout"}),Object(l.b)("h1",{className:"__internal",id:"nodejs原型链污染"},"nodejs原型链污染",Object(l.b)("a",p({parentName:"h1"},{href:"#nodejs%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93","aria-hidden":!0,className:"anchor"}),"#")),Object(l.b)("p",null,"js 是由对象组成的，对象与对象之间存在着继承关系"),Object(l.b)("p",null,"每个对象都有一个指向它的原型的内部链接，而这个原型对象又有他自己的原型，直到 null 为止"),Object(l.b)("p",null,"整体看来就是多个对象层层继承，实例对象的原型链接形成了一条链，也就是 js 的原型链"),Object(l.b)("p",null,"在 js 中每个函数都有一个 prototype 属性，而每个对象中也有一个 ",Object(l.b)("strong",{parentName:"p"},"proto")," 属性用来指向实例对象的原型"),Object(l.b)("p",null,"而每个原型也都有一个 constructor 属性执行相关联的构造函数，我们就是通过构造函数生成实例化的对象"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/3.png",alt:"3.png"}))),Object(l.b)("p",null,"由于对象之间存在继承关系，所以当我们要使用或者输出一个变量就会通过原型链向上搜索，当上层没有就会再向上上层搜索，直到指向 null，若此时还未找到就会返回 undefined"),Object(l.b)("p",null,"这幅图的原型链是 cat->Cat.protype->Object.prototype->null"),Object(l.b)("p",null,"而如果修改了一个对象的原型，那么会影响所有来自于这个原型的对象，这就是原型链污染"),Object(l.b)("p",null,"原型链污染通常出现在对象，数组的键名或者属性名可控，同时是赋值语句的情况下 ( 通常使用 json 传值 )"),Object(l.b)("p",null,"可以使用 npm audit 检查漏洞，（npm audit 是 npm 6新增的一个命令，可以允许开发人员分析复杂的代码并查明特定的漏洞）"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/2.png",alt:"2.png"}))),Object(l.b)("p",null,"其中常见的危险函数有"),Object(l.b)("p",null,"merge()"),Object(l.b)("p",null,"clone()"),Object(l.b)("p",null,"以及一些插件，例如比赛中出现的"),Object(l.b)("p",null,"Ciscn2020 初赛\tset-value"),Object(l.b)("p",null,"网鼎杯2020 青龙组\tundefsafe  版本<2.0.3"),Object(l.b)("p",null,"以下用比赛中的一个环境举例"),Object(l.b)("p",null,"目标是修改预设好的 Admin","[key]"," 使它等于我们传入的 password"),Object(l.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(l.b)("pre",p({parentName:"div"},{className:"language-text"}),Object(l.b)("code",p({parentName:"pre"},{className:"language-text"}),'router.post("/DeveloperControlPanel", function (req, res, next) {\n    // not implement\n    if (req.body.key === undefined || req.body.password === undefined){\n        res.send("What\'s your problem?");\n    }else {\n        let key = req.body.key.toString();\n        let password = req.body.password.toString();\n        if(Admin[key] === password){\n            res.send("You get flag !");\n        }else {\n            res.send("Wrong password!Are you Admin?");\n        }\n    }\n});'))),Object(l.b)("p",null,"以下为可利用的关键代码，稍微改改源码后本地起一个服务"),Object(l.b)("div",{className:"rcpress-highlight","data-language":"text"},Object(l.b)("pre",p({parentName:"div"},{className:"language-text"}),Object(l.b)("code",p({parentName:"pre"},{className:"language-text"}),'const setFn = require(\'set-value\');\nrouter.get(\'/SpawnPoint\', function (req, res, next) {\n    req.session.knight = {\n        "HP": 1000,\n        "Gold": 10,\n        "Firepower": 10\n    }\n    res.send("Let\'s begin!");\n});\n\nrouter.post("/Privilege", function (req, res, next) {\n    // Why not ask witch for help?\n    if(req.session.knight === undefined){\n        res.redirect(\'/SpawnPoint\');\n    }else{\n        if (req.body.NewAttributeKey === undefined || req.body.NewAttributeValue === undefined) {\n            res.send("What\'s your problem?");\n        }else {\n            let key = req.body.NewAttributeKey.toString();\n            let value = req.body.NewAttributeValue.toString();\n            setFn(req.session.knight, key, value);\n            res.send("OK");\n\t\t\tconsole.dir(req.session.knight.__proto__)\n        }\n    }\n});'))),Object(l.b)("p",null,"可以看到此处存在一个赋值操作，同时键名和键值都可控"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/4.png",alt:"4.png"}))),Object(l.b)("p",null,"req.session.knight 添加了新的属性"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/5.png",alt:"5.png"}))),Object(l.b)("p",null,"结合上面所说，我们可以直接利用这里给原链赋值，从而给之后的所有原型都加上一个新的属性，然后验证新添加的键名，并传入键值即可达成目标"),Object(l.b)("p",null,"req.session.knight 的上上层是 null ，给它的原链加一个新属性"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/7.png",alt:"7.png"}))),Object(l.b)("p",null,"添加成功"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/6.png",alt:"6"}))),Object(l.b)("p",null,"由于 Admin 没有这个变量就会通过原型链向上搜索，从而找到我们刚添加的 newpsw"),Object(l.b)("p",null,Object(l.b)("img",p({parentName:"p"},{src:"/images/js-prototype-chain-pollution/8.png",alt:"8.png"}))),Object(l.b)("p",null,"可以发现我们成功污染了原型链，并通过了验证"))}d.isMDXComponent=!0,d=Object(r.hot)(e)(d),(s="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.default:void 0)&&(s.register(i,"makeShortcode","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\ctf\\js-prototype-chain-pollution.md"),s.register(b,"layoutProps","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\ctf\\js-prototype-chain-pollution.md"),s.register(u,"MDXLayout","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\ctf\\js-prototype-chain-pollution.md"),s.register(d,"MDXContent","E:\\Code\\Project\\wgpsec\\WgpsecWiki\\docs\\knowledge\\ctf\\js-prototype-chain-pollution.md")),(c="undefined"!=typeof reactHotLoaderGlobal?reactHotLoaderGlobal.leaveModule:void 0)&&c(e)}.call(this,n(23)(e))}}]);